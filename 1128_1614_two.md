# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\report\controller\ReportController.java

```java
package com.codehows.taelimbe.report.controller;

import com.codehows.taelimbe.report.dto.ReportDTO;
import com.codehows.taelimbe.report.service.ReportService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/report")
public class ReportController {

    private final ReportService reportService;

    // ================= 1) 전체 Report 동기화 =================
    @PostMapping("/sync")
    public ResponseEntity<String> syncReports(
            @RequestParam Long storeId,
            @RequestParam(name = "start_time") long queryStartTime,
            @RequestParam(name = "end_time") long queryEndTime,
            @RequestParam(defaultValue = "0") int timezoneOffset
    ) {
        int count = reportService.syncReportsByStoreId(
                storeId,
                queryStartTime,
                queryEndTime,
                timezoneOffset
        );
        return ResponseEntity.ok(count + "개 Report 저장/업데이트 완료");
    }

    // ================= 2) 단일 Report 상세 저장 =================
    @PostMapping("/save-detail")
    public ResponseEntity<ReportDTO> saveReportDetail(
            @RequestParam Long storeId,
            @RequestParam String sn,
            @RequestParam String report_id,
            @RequestParam(name = "start_time") long queryStartTime,
            @RequestParam(name = "end_time") long queryEndTime,
            @RequestParam(defaultValue = "0") int timezoneOffset
    ) {
        return ResponseEntity.ok(
                reportService.saveReportDetailByStoreId(
                        storeId,
                        sn,
                        report_id,
                        queryStartTime,
                        queryEndTime,
                        timezoneOffset
                )
        );
    }

    // ================= 3) 전체 조회 =================
    @GetMapping("/list")
    public ResponseEntity<List<ReportDTO>> getAllReports() {
        return ResponseEntity.ok(reportService.getAllReports());
    }

    // ================= 4) ID 조회 =================
    @GetMapping("/{reportId}")
    public ResponseEntity<ReportDTO> getReportById(@PathVariable Long reportId) {
        return ResponseEntity.ok(reportService.getReportById(reportId));
    }

    // ================= 5) 로봇 SN 기준 조회 =================
    @GetMapping("/robot/{sn}")
    public ResponseEntity<List<ReportDTO>> getReportsByRobotSn(@PathVariable String sn) {
        return ResponseEntity.ok(reportService.getReportsByRobotSn(sn));
    }


}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\report\dto\ReportDTO.java

```java
package com.codehows.taelimbe.report.dto;

import com.codehows.taelimbe.report.entity.Report;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.*;
import java.time.LocalDateTime;

@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ReportDTO {

    private Long reportId;
    private Integer status;

    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime startTime;

    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime endTime;

    private Float cleanTime;
    private Float taskArea;
    private Float cleanArea;

    private Integer mode;
    private Long costBattery;
    private Long costWater;

    private String mapName;
    private String mapUrl;

    private Long robotId;

    public static ReportDTO createReportDTO(Report report) {
        return ReportDTO.builder()
                .reportId(report.getReportId())
                .status(report.getStatus())
                .startTime(report.getStartTime())
                .endTime(report.getEndTime())
                .cleanTime(report.getCleanTime())
                .taskArea(report.getTaskArea())
                .cleanArea(report.getCleanArea())
                .mode(report.getMode())
                .costBattery(report.getCostBattery())
                .costWater(report.getCostWater())
                .mapName(report.getMapName())
                .mapUrl(report.getMapUrl())
                .robotId(report.getRobot().getRobotId())
                .build();
    }
}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\report\entity\Report.java

```java
package com.codehows.taelimbe.report.entity;

import com.codehows.taelimbe.robot.entity.Robot;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "report")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Report {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "report_id")
    private Long reportId;

    @Column(name = "task_id")
    private Long taskId;

    @Column(name = "status")
    private Integer status;

    @Column(name = "start_time")
    private LocalDateTime startTime;

    @Column(name = "end_time")
    private LocalDateTime endTime;

    @Column(name = "clean_time")
    private Float cleanTime;

    @Column(name = "task_area")
    private Float taskArea;

    @Column(name = "clean_area")
    private Float cleanArea;

    @Column(name = "mode")
    private Integer mode;

    @Column(name = "cost_battery")
    private Long costBattery;

    @Column(name = "cost_water")
    private Long costWater;

    @Column(name = "map_name", length = 255)
    private String mapName;

    @Column(name = "map_url", length = 255)
    private String mapUrl;

    @ManyToOne
    @JoinColumn(name = "robot_id")
    private Robot robot;

    // ================= Constructor for Required Fields =================
    public Robot(String sn, String mac, Store store) {
        this.sn = sn;
        this.mac = mac;
        this.store = store;
    }

    // ================= Update Methods =================
    public void updateRobotInfo(String nickname, boolean online, int battery,
                                int status, String productCode, String softVersion) {
        this.nickname = nickname;
        this.online = online;
        this.battery = battery;
        this.status = status;
        this.productCode = productCode;
        this.softVersion = softVersion;
    }

    public void changeStore(Store store) {
        this.store = store;
    }

}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\report\repository\ReportRepository.java

```java
package com.codehows.taelimbe.report.repository;

import com.codehows.taelimbe.report.entity.Report;
import org.springframework.data.jpa.repository.JpaRepository;

import java.time.LocalDateTime;
import java.util.List;

public interface ReportRepository extends JpaRepository<Report, Long> {
    List<Report> findByRobot_Sn(String sn);

    List<Report> findByStartTimeBetween(LocalDateTime start, LocalDateTime end);
}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\report\service\ReportService.java

```java
package com.codehows.taelimbe.report.service;

import com.codehows.taelimbe.client.PuduAPIClient;
import com.codehows.taelimbe.report.dto.ReportDTO;
import com.codehows.taelimbe.report.entity.Report;
import com.codehows.taelimbe.robot.entity.Robot;
import com.codehows.taelimbe.store.entity.Store;
import com.codehows.taelimbe.report.repository.ReportRepository;
import com.codehows.taelimbe.robot.repository.RobotRepository;
import com.codehows.taelimbe.store.repository.StoreRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.util.UriComponentsBuilder;

import java.time.*;
import java.util.*;

@Service
@RequiredArgsConstructor
public class ReportService {

    private final PuduAPIClient puduAPIClient;
    private final ReportRepository reportRepository;
    private final RobotRepository robotRepository;
    private final StoreRepository storeRepository;
    private final ObjectMapper mapper = new ObjectMapper();


    public List<ReportDTO> getReport(String startDate, String endDate) {

        if (startDate == null || startDate.isEmpty()) {
            startDate = LocalDate.now().minusWeeks(1).toString();
        }
        if (endDate == null || endDate.isEmpty()) {
            endDate = LocalDate.now().toString();
        }

        // 문자열 형태의 시작일을 `LocalDate` 객체로 파싱하고, 해당 날짜의 시작 시간(00:00:00)으로 `LocalDateTime`을 생성합니다.
        LocalDateTime startDateTime = LocalDate.parse(startDate).atStartOfDay();
        // 문자열 형태의 종료일을 `LocalDate` 객체로 파싱하고, 해당 날짜의 마지막 시간(23:59:59.999999999)으로 `LocalDateTime`을 생성합니다.
        LocalDateTime endDateTime = LocalDate.parse(endDate).atTime(LocalTime.MAX);

        return reportRepository.findByStartTimeBetween(startDateTime, endDateTime)
                .stream().map(ReportDTO::createReportDTO)
                .toList();
    }

    // ================================= ================
    // 1) 매장 단위 전체 동기화
    // ================================= ================
    @Transactional
    public int syncReportsByStoreId(
            Long storeId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset
    ) {
        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));

        Long shopId = store.getShopId();

        // offset=0, limit=20 자동 적용 (고정)
        List<Map<String, String>> list = 
                fetchReportList(queryStartTime, queryEndTime, shopId, timezoneOffset);

        int count = 0;
        for (Map<String, String> item : list) {
            ReportDTO saved = saveReportDetail(
                    item.get("sn"),
                    item.get("report_id"),
                    queryStartTime,
                    queryEndTime,
                    timezoneOffset,
                    shopId
            );
            if (saved != null) count++;
        }
        return count;
    }


    // ================================= ================
    // 2) 단일 저장 (Store 기준)
    // ================================= ================
    @Transactional
    public ReportDTO saveReportDetailByStoreId(
            Long storeId,
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset
    ) {

        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));

        return saveReportDetail(
                sn,
                reportId,
                queryStartTime,
                queryEndTime,
                timezoneOffset,
                store.getShopId()
        );
    }


    // ================================= ================
    // 3) 단일 저장 (내부)
    // ================================= ================
    @Transactional
    public ReportDTO saveReportDetail(
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset,
            Long shopId
    ) {
        JsonNode detail = fetchReportDetail(
                sn,
                reportId,
                queryStartTime,
                queryEndTime,
                timezoneOffset,
                shopId
        );

        if (detail == null) return null;

        return convertAndSave(detail, sn, timezoneOffset);
    }


    // ================================= ================
    // 4) 전체 조회
    // ================================= ================
    public List<ReportDTO> getAllReports() {
        return reportRepository.findAll()
                .stream().map(this::toDto).toList();
    }

    public ReportDTO getReportById(Long id) {
        return toDto(reportRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Report not found")));
    }

    public List<ReportDTO> getReportsByRobotSn(String sn) {
        return reportRepository.findByRobot_Sn(sn)
                .stream().map(this::toDto).toList();
    }


    // ================================= ================
    // 5) 삭제
    // ================================= ================
    @Transactional
    public void deleteReport(Long id) {
        reportRepository.deleteById(id);
    }


    // ================================= ================
    // API 1) Cleaning Report - List 조회 (offset/limit 고정)
    // ================================= ================
    private List<Map<String, String>> fetchReportList(
            long queryStartTime,
            long queryEndTime,
            Long shopId,
            int timezoneOffset
    ) {
        List<Map<String, String>> result = new ArrayList<>();

        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-board/v1/log/clean_task/query_list")
                    .queryParam("start_time", queryStartTime)
                    .queryParam("end_time", queryEndTime)
                    .queryParam("shop_id", shopId)
                    .queryParam("offset", 0)
                    .queryParam("limit", 20)

                    .queryParam("timezone_offset", timezoneOffset)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            JsonNode list = mapper.readTree(res.getBody())
                    .path("data")
                    .path("list");

            if (list.isArray()) {
                for (JsonNode n : list) {
                    Map<String, String> map = new HashMap<>();
                    map.put("sn", n.path("sn").asText());
                    map.put("report_id", n.path("report_id").asText());
                    result.add(map);
                }
            }

        } catch (Exception ignored) {}

        return result;
    }


    // ================================= ================
    // API 2) Cleaning Report - Detail 조회
    // ================================= ================
    private JsonNode fetchReportDetail(
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset,
            Long shopId
    ) {
        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-board/v1/log/clean_task/query")
                    .queryParam("sn", sn)
                    .queryParam("report_id", reportId)
                    .queryParam("start_time", queryStartTime)
                    .queryParam("end_time", queryEndTime)
                    .queryParam("timezone_offset", timezoneOffset)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            System.out.println("DETAIL URL = " + url);
            System.out.println("DETAIL RESPONSE = " + res.getBody());

            return mapper.readTree(res.getBody()).path("data");

        } catch (Exception ignored) {}

        return null;
    }


    // ================================= ================
    // 변환 + DB 저장 (floor_list JSON 문자열 대응 버전)
    // ================================= ================
    private ReportDTO convertAndSave(JsonNode n, String sn, int timezoneOffset) {

        Robot robot = robotRepository.findBySn(sn)
                .orElseThrow(() -> new IllegalArgumentException("Robot not found"));

        // ----------------------------------------
        // floor_list가 "문자열(String)" 형태로 내려오므로 파싱 필요
        // ----------------------------------------
        JsonNode floorListNode = n.path("floor_list");
        String mapName = null;
        String mapUrl = null;

        try {
            // Case 1: floor_list가 문자열(JSON 텍스트)로 내려오는 경우
            if (floorListNode.isTextual()) {
                String floorListJson = floorListNode.asText();     // 문자열 추출

                JsonNode floorList = mapper.readTree(floorListJson); // JSON으로 다시 파싱

                if (floorList.isArray() && floorList.size() > 0) {
                    JsonNode first = floorList.get(0);

                    mapName = first.path("map_name").asText(null);

                    // task_result_url → 없으면 task_local_url
                    mapUrl = first.path("task_result_url").asText(
                            first.path("task_local_url").asText(null)
                    );
                }
            }

            // Case 2: 혹시 floor_list가 정상적인 배열로 내려올 때 (예비 대비)
            else if (floorListNode.isArray() && floorListNode.size() > 0) {
                JsonNode first = floorListNode.get(0);

                mapName = first.path("map_name").asText(null);
                mapUrl = first.path("task_result_url").asText(
                        first.path("task_local_url").asText(null)
                );
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        // ----------------------------------------
        // Report 엔티티 생성
        // ----------------------------------------
        Report report = Report.builder()
                .status(n.path("status").asInt())
                .startTime(toLocal(n.path("start_time").asLong(), timezoneOffset))
                .endTime(toLocal(n.path("end_time").asLong(), timezoneOffset))
                .cleanTime(n.path("clean_time").floatValue())
                .taskArea(n.path("task_area").floatValue())
                .cleanArea(n.path("clean_area").floatValue())
                .mode(n.path("mode").asInt())
                .costBattery(n.path("cost_battery").asLong())
                .costWater(n.path("cost_water").asLong())
                .mapName(mapName)
                .mapUrl(mapUrl)
                .robot(robot)
                .build();

        return toDto(reportRepository.save(report));
    }



    // ================================= ================
    // DTO 변환
    // ================================= ================
    private ReportDTO toDto(Report r) {
        return ReportDTO.builder()
                .reportId(r.getReportId())
                .status(r.getStatus())
                .startTime(r.getStartTime())
                .endTime(r.getEndTime())
                .cleanTime(r.getCleanTime())
                .taskArea(r.getTaskArea())
                .cleanArea(r.getCleanArea())
                .mode(r.getMode())
                .costBattery(r.getCostBattery())
                .costWater(r.getCostWater())
                .mapName(r.getMapName())
                .mapUrl(r.getMapUrl())
                .robotId(r.getRobot().getRobotId())
                .build();
    }


    // ================================= ================
    // Timestamp 변환 함수
    // ================================= ================
    private LocalDateTime toLocal(long epoch, int timezoneOffset) {
        long adjusted = epoch + (timezoneOffset * 60L);
        return LocalDateTime.ofInstant(Instant.ofEpochSecond(adjusted), ZoneId.systemDefault());
    }
}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\robot\controller\RobotController.java

```java
package com.codehows.taelimbe.robot.controller;

import com.codehows.taelimbe.robot.dto.RobotDTO;
import com.codehows.taelimbe.robot.service.RobotService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/robot")
public class RobotController {

    private final RobotService robotService;

    // 1) 전체 Robot 동기화(API → DB)
    @PostMapping("/sync")
    public ResponseEntity<String> syncRobots(@RequestParam Long storeId) {
        int count = robotService.syncRobotsByStoreId(storeId);
        return ResponseEntity.ok(count + "개 Robot 저장/업데이트 완료");
    }

    // 2) 단일 조회(DB + API 최신값 병합)
    @GetMapping("/info")
    public ResponseEntity<RobotDTO> getRobotInfo(
            @RequestParam Long storeId,
            @RequestParam String sn
    ) {
        return ResponseEntity.ok(robotService.getRobotInfoByStoreId(sn, storeId));
    }

    // 3) 전체 Robot 조회(DB 전용)
    @GetMapping("/list")
    public ResponseEntity<List<RobotDTO>> getRobotList(
            @RequestParam Long storeId
    ) {
        return ResponseEntity.ok(robotService.getRobotListFromDB(storeId));
    }


}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\robot\dto\RobotDTO.java

```java
package com.codehows.taelimbe.robot.dto;

import lombok.*;

@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Setter
public class RobotDTO {

    private Long robotId;
    private String sn;
    private String mac;

    private String nickname;
    private boolean online;
    private Integer battery;
    private Integer status;

    private String productCode;
    private String softVersion;

    private Long storeId;
}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\robot\entity\Robot.java

```java
package com.codehows.taelimbe.robot.entity;

import com.codehows.taelimbe.store.entity.Store;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "robot")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Robot {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "robot_id")
    private Long robotId;

    @Column(nullable = false, unique = true)
    private String sn;

    @Column(nullable = false, unique = true)
    private String mac;

    private String nickname;
    private Boolean online;
    private Integer battery;
    private Integer status;
    private String productCode;
    private String softVersion;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "store_id")
    private Store store;

    // ================= Constructor for Required Fields =================
    public Robot(String sn, String mac, Store store) {
        this.sn = sn;
        this.mac = mac;
        this.store = store;
    }

    // ================= Update Methods =================
    public void updateRobotInfo(String nickname, boolean online, int battery,
                                int status, String productCode, String softVersion) {
        this.nickname = nickname;
        this.online = online;
        this.battery = battery;
        this.status = status;
        this.productCode = productCode;
        this.softVersion = softVersion;
    }

    public void changeStore(Store store) {
        this.store = store;
    }
}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\robot\repository\RobotRepository.java

```java
package com.codehows.taelimbe.robot.repository;

import com.codehows.taelimbe.robot.entity.Robot;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface RobotRepository extends JpaRepository<Robot, Long> {

    Optional<Robot> findBySn(String sn);
    Optional<Robot> findByMac(String mac);

    // Store.storeId = storeId
    List<Robot> findAllByStore_StoreId(Long storeId);



}
```

# File: C:\tealim-be\src\main\java\com\codehows\taelimbe\robot\service\RobotService.java

```java
package com.codehows.taelimbe.robot.service;

import com.codehows.taelimbe.client.PuduAPIClient;
import com.codehows.taelimbe.robot.dto.RobotDTO;
import com.codehows.taelimbe.robot.entity.Robot;
import com.codehows.taelimbe.store.entity.Store;
import com.codehows.taelimbe.robot.repository.RobotRepository;
import com.codehows.taelimbe.store.repository.StoreRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.util.UriComponentsBuilder;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class RobotService {

    private final PuduAPIClient puduAPIClient;
    private final RobotRepository robotRepository;
    private final StoreRepository storeRepository;
    private final ObjectMapper mapper = new ObjectMapper();

    // 1) API → DB 저장 (동기화)
    @Transactional
    public int syncRobotsByStoreId(Long storeId) {
        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));
        Long shopId = store.getShopId();

        // ⚠ API 전용 메서드 (그대로 유지)
        List<RobotDTO> robots = getRobotListByShop(shopId);

        int cnt = 0;
        for (RobotDTO dto : robots) {
            saveRobot(dto, store);
            cnt++;
        }
        return cnt;
    }

    // 2) DB 조회 전용(list)
    public List<RobotDTO> getRobotListFromDB(Long storeId) {
        return robotRepository.findAllByStore_StoreId(storeId)
                .stream()
                .map(this::convertToDto)
                .collect(Collectors.toList());
    }

    // 3) 단일 조회(DB + API 병합)
    public RobotDTO getRobotInfoByStoreId(String sn, Long storeId) {
        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));

        Long shopId = store.getShopId();

        RobotDTO api = getRobotInfo(sn, shopId);
        Robot robot = robotRepository.findBySn(sn).orElse(null);
        // DB 없을 때 API만 반환
        if (robot == null) return api;
        RobotDTO dto = convertToDto(robot);

        // API 최신값 덮어쓰기
        dto.setBattery(api.getBattery());
        dto.setOnline(api.isOnline());
        dto.setStatus(api.getStatus());
        dto.setProductCode(api.getProductCode());
        dto.setSoftVersion(api.getSoftVersion());

        return dto;
    }

    // 4) Robot 저장(DB 업데이트)
    @Transactional
    public Robot saveRobot(RobotDTO dto, Store store) {
        Robot robot = robotRepository.findBySn(dto.getSn())
                .orElseGet(() -> new Robot(dto.getSn(), dto.getMac(), store));

        robot.updateRobotInfo(
                dto.getNickname(),
                dto.isOnline(),
                dto.getBattery(),
                dto.getStatus(),
                dto.getProductCode(),
                dto.getSoftVersion()
        );

        robot.changeStore(store);

        return robotRepository.save(robot);
    }

    // 5) API 단일 상세 조회 정보 조립
    public RobotDTO getRobotInfo(String sn, Long shopId) {
        String mac = null;
        String nickname = null;
        boolean online = false;
        int battery = 0;
        int status = 0;
        String productCode = null;
        String softVersion = null;

        JsonNode base = fetchRobotBySn(sn, shopId);
        if (base != null) mac = base.path("mac").asText(null);

        JsonNode detail = fetchRobotDetail(sn);
        if (detail != null) {
            nickname = detail.path("nickname").asText(null);
            battery = detail.path("battery").asInt();
            online = detail.path("online").asBoolean();
            status = detail.path("cleanbot").path("clean").path("status").asInt();
        }

        JsonNode charge = fetchLatestChargeLog(sn, shopId);
        if (charge != null) {
            productCode = charge.path("product_code").asText(null);
            softVersion = charge.path("soft_version").asText(null);
        }

        return RobotDTO.builder()
                .sn(sn)
                .mac(mac)
                .nickname(nickname)
                .online(online)
                .battery(battery)
                .status(status)
                .productCode(productCode)
                .softVersion(softVersion)
                .build();
    }

    // 6) Shop 기준 전체 조회(API 전용)
    public List<RobotDTO> getRobotListByShop(Long shopId) {
        List<JsonNode> list = fetchRobotListAll(shopId);
        List<RobotDTO> result = new ArrayList<>();

        for (JsonNode node : list) {
            String sn = node.path("sn").asText();
            result.add(getRobotInfo(sn, shopId));
        }

        return result;
    }

    // 7) API 호출들
    private List<JsonNode> fetchRobotListAll(Long shopId) {
        List<JsonNode> list = new ArrayList<>();

        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-open-platform-service/v1/api/robot")
                    .queryParam("limit", 100)
                    .queryParam("offset", 0)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            JsonNode arr = mapper.readTree(res.getBody()).path("data").path("list");

            if (arr.isArray()) arr.forEach(list::add);

        } catch (Exception ignored) {}

        return list;
    }

    private JsonNode fetchRobotBySn(String sn, Long shopId) {
        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-open-platform-service/v1/api/robot")
                    .queryParam("limit", 100)
                    .queryParam("offset", 0)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            JsonNode nodes = mapper.readTree(res.getBody()).path("data").path("list");

            for (JsonNode n : nodes) {
                if (sn.equals(n.path("sn").asText())) return n;
            }

        } catch (Exception ignored) {}

        return null;
    }

    private JsonNode fetchRobotDetail(String sn) {
        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/cleanbot-service/v1/api/open/robot/detail")
                    .queryParam("sn", sn)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            return mapper.readTree(res.getBody()).path("data");

        } catch (Exception ignored) {}

        return null;
    }

    private JsonNode fetchLatestChargeLog(String sn, Long shopId) {
        long end = System.currentTimeMillis() / 1000;
        long start = end - 60L * 60 * 24 * 90;

        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-board/v1/log/charge/query_list")
                    .queryParam("start_time", start)
                    .queryParam("end_time", end)
                    .queryParam("limit", 1)
                    .queryParam("offset", 0)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            JsonNode arr = mapper.readTree(res.getBody()).path("data").path("list");

            if (arr.isArray() && arr.size() > 0) return arr.get(0);

        } catch (Exception ignored) {}

        return null;
    }

    // 7) Robot → DTO 변환 (DB)
    private RobotDTO convertToDto(Robot robot) {
        return RobotDTO.builder()
                .robotId(robot.getRobotId())
                .sn(robot.getSn())
                .mac(robot.getMac())
                .nickname(robot.getNickname())
                .online(robot.getOnline())
                .battery(robot.getBattery())
                .status(robot.getStatus())
                .productCode(robot.getProductCode())
                .softVersion(robot.getSoftVersion())
                .storeId(robot.getStore().getStoreId())
                .build();
    }
}
```