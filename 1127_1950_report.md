# Report Feature Source Code

## `Report.java`

```java
package com.codehows.taelimbe.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "report")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Report {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "report_id")
    private Long reportId;

    @Column(name = "status")
    private Integer status;

    @Column(name = "start_time")
    private LocalDateTime startTime;

    @Column(name = "end_time")
    private LocalDateTime endTime;

    @Column(name = "clean_time")
    private Float cleanTime;

    @Column(name = "task_area")
    private Float taskArea;

    @Column(name = "clean_area")
    private Float cleanArea;

    @Column(name = "mode")
    private Integer mode;

    @Column(name = "cost_battery")
    private Long costBattery;

    @Column(name = "cost_water")
    private Long costWater;

    @Column(name = "map_name", length = 255)
    private String mapName;

    @Column(name = "map_url", length = 255)
    private String mapUrl;

    @ManyToOne
    @JoinColumn(name = "robot_id")
    private Robot robot;

}
```

## `AiReport.java`

```java
//package com.codehows.taelimbe.entity;
//
//import jakarta.persistence.*;
//import lombok.*;
//
//import java.time.LocalDateTime;
//
//@Entity
//@Table(name = "ai_report")
//@NoArgsConstructor
//@AllArgsConstructor
//@Getter
//@Setter
//@Builder
//public class AiReport {
//
//    @Id
//    @GeneratedValue(strategy = GenerationType.IDENTITY)
//    @Column(name = "report_history_id")
//    private Long reportHistoryId;
//
//    @Column(name = "conversation_id", length = 10)
//    private String conversationId;
//
//    @Column(name = "start_time")
//    private LocalDateTime startTime;
//
//    @Column(name = "end_time")
//    private LocalDateTime endTime;
//
//    @Column(name = "created_at")
//    private LocalDateTime createdAt;
//
//    @Column(name = "raw_message", columnDefinition = "TEXT")
//    private String rawMessage;
//
//    @Column(name = "raw_report", columnDefinition = "TEXT")
//    private String rawReport;
//
//    @ManyToOne
//    @JoinColumn(name = "user_id")
//    private User user;
//
//}
```

## `ReportDTO.java`

```java
package com.codehows.taelimbe.dto;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.*;
import java.time.LocalDateTime;

@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ReportDTO {

    private Long reportId;
    private Integer status;

    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime startTime;

    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime endTime;

    private Float cleanTime;
    private Float taskArea;
    private Float cleanArea;

    private Integer mode;
    private Long costBattery;
    private Long costWater;

    private String mapName;
    private String mapUrl;

    private Long robotId;
    private String robotSn;
}
```

## `ReportController.java`

```java
package com.codehows.taelimbe.controller;

import com.codehows.taelimbe.dto.ReportDTO;
import com.codehows.taelimbe.service.ReportService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/report")
public class ReportController {

    private final ReportService reportService;

    // ================= 1) 전체 Report 동기화 =================
    @PostMapping("/sync")
    public ResponseEntity<String> syncReports(
            @RequestParam Long storeId,
            @RequestParam(name = "start_time") long queryStartTime,
            @RequestParam(name = "end_time") long queryEndTime,
            @RequestParam(defaultValue = "0") int timezoneOffset
    ) {
        int count = reportService.syncReportsByStoreId(
                storeId,
                queryStartTime,
                queryEndTime,
                timezoneOffset
        );
        return ResponseEntity.ok(count + "개 Report 저장/업데이트 완료");
    }

    // ================= 2) 단일 Report 상세 저장 =================
    @PostMapping("/save-detail")
    public ResponseEntity<ReportDTO> saveReportDetail(
            @RequestParam Long storeId,
            @RequestParam String sn,
            @RequestParam String report_id,
            @RequestParam(name = "start_time") long queryStartTime,
            @RequestParam(name = "end_time") long queryEndTime,
            @RequestParam(defaultValue = "0") int timezoneOffset
    ) {
        return ResponseEntity.ok(
                reportService.saveReportDetailByStoreId(
                        storeId,
                        sn,
                        report_id,
                        queryStartTime,
                        queryEndTime,
                        timezoneOffset
                )
        );
    }

    // ================= 3) 전체 조회 =================
    @GetMapping("/list")
    public ResponseEntity<List<ReportDTO>> getAllReports() {
        return ResponseEntity.ok(reportService.getAllReports());
    }

    // ================= 4) ID 조회 =================
    @GetMapping("/{reportId}")
    public ResponseEntity<ReportDTO> getReportById(@PathVariable Long reportId) {
        return ResponseEntity.ok(reportService.getReportById(reportId));
    }

    // ================= 5) 로봇 SN 기준 조회 =================
    @GetMapping("/robot/{sn}")
    public ResponseEntity<List<ReportDTO>> getReportsByRobotSn(@PathVariable String sn) {
        return ResponseEntity.ok(reportService.getReportsByRobotSn(sn));
    }

    // ================= 6) 삭제 =================
    @DeleteMapping("/{reportId}")
    public ResponseEntity<String> deleteReport(@PathVariable Long reportId) {
        reportService.deleteReport(reportId);
        return ResponseEntity.ok("Report 삭제 완료");
    }
}
```

## `ReportService.java`

```java
package com.codehows.taelimbe.service;

import com.codehows.taelimbe.client.PuduAPIClient;
import com.codehows.taelimbe.dto.ReportDTO;
import com.codehows.taelimbe.entity.Report;
import com.codehows.taelimbe.entity.Robot;
import com.codehows.taelimbe.entity.Store;
import com.codehows.taelimbe.repository.ReportRepository;
import com.codehows.taelimbe.repository.RobotRepository;
import com.codehows.taelimbe.repository.StoreRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.util.UriComponentsBuilder;

import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.*;

@Service
@RequiredArgsConstructor
public class ReportService {

    private final PuduAPIClient puduAPIClient;
    private final ReportRepository reportRepository;
    private final RobotRepository robotRepository;
    private final StoreRepository storeRepository;
    private final ObjectMapper mapper = new ObjectMapper();


    // ================= 1) 전체 동기화 =================
    @Transactional
    public int syncReportsByStoreId(
            Long storeId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset
    ) {

        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));

        Long shopId = store.getShopId();

        List<Map<String, String>> list =
                fetchReportList(queryStartTime, queryEndTime, shopId);

        int count = 0;
        for (Map<String, String> item : list) {
            ReportDTO saved = saveReportDetail(
                    item.get("sn"),
                    item.get("report_id"),
                    queryStartTime,
                    queryEndTime,
                    timezoneOffset,
                    shopId
            );
            if (saved != null) count++;
        }
        return count;
    }


    // ================= 2) 단일 저장 (Store 기준) =================
    @Transactional
    public ReportDTO saveReportDetailByStoreId(
            Long storeId,
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset
    ) {

        Store store = storeRepository.findById(storeId)
                .orElseThrow(() -> new IllegalArgumentException("Store not found"));

        return saveReportDetail(
                sn,
                reportId,
                queryStartTime,
                queryEndTime,
                timezoneOffset,
                store.getShopId()
        );
    }


    // ================= 3) 단일 저장 (내부) =================
    @Transactional
    public ReportDTO saveReportDetail(
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset,
            Long shopId
    ) {

        JsonNode detail = fetchReportDetail(
                sn,
                reportId,
                queryStartTime,
                queryEndTime,
                timezoneOffset,
                shopId
        );

        if (detail == null) return null;

        return convertAndSave(detail, sn, timezoneOffset);
    }


    // ================= 4) 전체 조회(DB) =================
    public List<ReportDTO> getAllReports() {
        return reportRepository.findAll()
                .stream().map(this::toDto).toList();
    }

    public ReportDTO getReportById(Long id) {
        return toDto(reportRepository.findById(id)
                .orElseThrow(() -> new IllegalArgumentException("Report not found")));
    }

    public List<ReportDTO> getReportsByRobotSn(String sn) {
        return reportRepository.findByRobot_Sn(sn)
                .stream().map(this::toDto).toList();
    }


    // ================= 5) 삭제 =================
    @Transactional
    public void deleteReport(Long id) {
        reportRepository.deleteById(id);
    }


    // ================= API 1) 리스트 조회 =================
    private List<Map<String, String>> fetchReportList(
            long queryStartTime,
            long queryEndTime,
            Long shopId
    ) {

        List<Map<String, String>> result = new ArrayList<>();

        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-board/v1/log/clean_task/query_list")
                    .queryParam("query_start_time", queryStartTime)
                    .queryParam("query_end_time", queryEndTime)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            JsonNode list = mapper.readTree(res.getBody())
                    .path("data")
                    .path("list");

            if (list.isArray()) {
                for (JsonNode n : list) {
                    Map<String, String> map = new HashMap<>();
                    map.put("sn", n.path("sn").asText());
                    map.put("report_id", n.path("report_id").asText());
                    result.add(map);
                }
            }
        } catch (Exception ignored) {}

        return result;
    }


    // ================= API 2) 상세 조회 =================
    private JsonNode fetchReportDetail(
            String sn,
            String reportId,
            long queryStartTime,
            long queryEndTime,
            int timezoneOffset,
            Long shopId
    ) {
        try {
            String url = UriComponentsBuilder.fromHttpUrl(puduAPIClient.getBaseUrl())
                    .path("/data-board/v1/log/clean_task/query")
                    .queryParam("sn", sn)
                    .queryParam("report_id", reportId)
                    .queryParam("query_start_time", queryStartTime)
                    .queryParam("query_end_time", queryEndTime)
                    .queryParam("timezone_offset", timezoneOffset)
                    .queryParam("shop_id", shopId)
                    .toUriString();

            ResponseEntity<String> res = puduAPIClient.callPuduAPI(url, "GET");

            //나중에 지울거
            System.out.println("DETAIL URL = " + url);
            System.out.println("DETAIL RESPONSE = " + res.getBody());
            // ★★★ 여기까지가 정확한 위치 ★★★



            return mapper.readTree(res.getBody()).path("data");

        } catch (Exception ignored) {}

        return null;
    }


    // ================= 저장 변환 =================
    private ReportDTO convertAndSave(JsonNode n, String sn, int timezoneOffset) {

        Robot robot = robotRepository.findBySn(sn)
                .orElseThrow(() -> new IllegalArgumentException("Robot not found"));

        Report report = Report.builder()
                .status(n.path("status").asInt())
                .startTime(toLocal(n.path("start_time").asLong(), timezoneOffset))
                .endTime(toLocal(n.path("end_time").asLong(), timezoneOffset))
                .cleanTime(n.path("clean_time").floatValue())
                .taskArea(n.path("task_area").floatValue())
                .cleanArea(n.path("clean_area").floatValue())
                .mode(n.path("mode").asInt())
                .costBattery(n.path("cost_battery").asLong())
                .costWater(n.path("cost_water").asLong())
                .mapName(n.path("map_name").asText(null))
                .mapUrl(n.path("map_url").asText(null))
                .robot(robot)
                .build();

        Report saved = reportRepository.save(report);

        return toDto(saved);
    }


    // ================= DTO 변환 =================
    private ReportDTO toDto(Report r) {
        return ReportDTO.builder()
                .reportId(r.getReportId())
                .status(r.getStatus())
                .startTime(r.getStartTime())
                .endTime(r.getEndTime())
                .cleanTime(r.getCleanTime())
                .taskArea(r.getTaskArea())
                .cleanArea(r.getCleanArea())
                .mode(r.getMode())
                .costBattery(r.getCostBattery())
                .costWater(r.getCostWater())
                .mapName(r.getMapName())
                .mapUrl(r.getMapUrl())
                .robotId(r.getRobot().getRobotId())
                .robotSn(r.getRobot().getSn())
                .build();
    }

    // ================= Timestamp 변환 =================
    private LocalDateTime toLocal(long epoch, int timezoneOffset) {
        long adjusted = epoch + (timezoneOffset * 60L);
        return LocalDateTime.ofInstant(Instant.ofEpochSecond(adjusted), ZoneId.systemDefault());
    }
}
```

## `ReportRepository.java`

```java
package com.codehows.taelimbe.repository;

import com.codehows.taelimbe.entity.Report;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ReportRepository extends JpaRepository<Report, Long> {
    List<Report> findByRobot_Sn(String sn);
}
```
