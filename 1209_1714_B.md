## src/main/java/com/codehows/taelimbe/ai/service/AgentService.java

`java

package com.codehows.taelimbe.ai.service;

import com.codehows.taelimbe.ai.dto.ChatPromptRequest;
import com.codehows.taelimbe.langchain.Agent;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.model.input.Prompt;
import dev.langchain4j.model.input.PromptTemplate;
import dev.langchain4j.service.TokenStream;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.io.IOException;
import java.util.Map;
import java.util.UUID;

/**
 * AI ?ì´?„íŠ¸?€???€??ë¡œì§??ìº¡ìŠ?”í•˜???œë¹„???´ë˜?¤ì…?ˆë‹¤.
 * `AgentController`??ë³µì¡?±ì„ ì¤„ì´ê³? ?€??ì²˜ë¦¬?€ ê´€?¨ëœ ëª¨ë“  ë¡œì§???´ê³³?ì„œ ê´€ë¦¬í•©?ˆë‹¤.
 * `@Service` ?´ë…¸?Œì´?˜ì? ???´ë˜?¤ê? ë¹„ì¦ˆ?ˆìŠ¤ ê³„ì¸µ??ì»´í¬?ŒíŠ¸?„ì„ ?˜í??…ë‹ˆ??
 * `@RequiredArgsConstructor`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? final ?„ë“œ???€???ì„±?ë? ?ë™?¼ë¡œ ?ì„±?˜ì—¬ ?˜ì¡´??ì£¼ì…???©ì´?˜ê²Œ ?©ë‹ˆ??
 * `@Slf4j`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? ë¡œê¹…???„í•œ `log` ê°ì²´ë¥??ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class AgentService {
    private final SseService sseService;
    private final AiChatService aiChatService;

    // LangChain4j Agent ?¸í„°?˜ì´?¤ì˜ êµ¬í˜„ì²´ë? ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    @Qualifier("reportAgent")
    private final Agent reportAgent;

    @Qualifier("chatAgent")
    private final Agent chatAgent;


    @Async("ChatAgentExecutor")
    public void process(String conversationId, String message, Long userId) {

        log.info("?” [process] START conversationId={}, userId={}, msg={}", conversationId, userId, message);
        // ?¬ìš©??ë©”ì‹œì§€ DB ?€??
        aiChatService.saveUserMessage(conversationId, userId, message);

        // LangChain4j ?¤íŠ¸ë¦¬ë° ?¸ì¶œ
        TokenStream stream = chatAgent.chat(message, conversationId);

        StringBuilder aiBuilder = new StringBuilder();

        // ? í° ?¤íŠ¸ë¦¬ë° ì²˜ë¦¬
        stream.onNext(token -> {
            aiBuilder.append(token);
            sseService.send(conversationId, token);
        });

        // TokenStream ë²„ì „??onComplete/onError/start ?†ìŒ ???¤íŠ¸ë¦¼ì´ ?ë‚˜ë©??ë™ ì¢…ë£Œ??
        try {
            // ê¸°ë‹¤ë¦??„ìš” ?†ìŒ ??LangChain4jê°€ ë°±ê·¸?¼ìš´?œì—???¤íŠ¸ë¦?ì²˜ë¦¬??
        } finally {
            // AI ë©”ì‹œì§€ ?€??
            aiChatService.saveAiMessage(conversationId, userId, aiBuilder.toString());
        }
    }

    public SseEmitter report(ChatPromptRequest req, Long userId) {

        SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);

        // ?„ì¬ ?¤ë ˆ?œì— ?¬ìš©???´ë¦„???¤ì •?˜ì—¬, ?„êµ¬ ?¸ì¶œ ?±ì—???¬ìš©??ì»¨í…?¤íŠ¸ë¥??œìš©?????ˆë„ë¡??©ë‹ˆ??
        // ?€??IDê°€ ?”ì²­???¬í•¨?˜ì–´ ?ˆì? ?Šë‹¤ë©??ˆë¡œ??IDë¥??ì„±?©ë‹ˆ??
        String convId = (req.getConversationId() == null || req.getConversationId().isBlank())
                ? UUID.randomUUID().toString()
                : req.getConversationId();

        PromptTemplate template = PromptTemplate.from("""
                  ?œê³µë°›ì? ?°ì´?°ì…‹??ë¶„ì„?˜ì—¬, ?„ì²´ ?”ì•½ê³??ì„¸ ë³´ê³ ?œë? ëª¨ë‘ ?¬í•¨?˜ëŠ” ë§ˆí¬?¤ìš´ ?•ì‹??ë¦¬í¬?¸ë? ?ì„±?˜ì„¸??\\n\\
                  ë¦¬í¬?¸ëŠ” ?¤ìŒ ??ª©???¬í•¨?´ì•¼ ?©ë‹ˆ??\\n\\
                  \\n\\
                  # ì´ê´„ ?”ì•½\\n\\
                  - ?°ì´?°ì˜ ?µì‹¬ ?¸ì‚¬?´íŠ¸?€ ê²°ë¡  ?”ì•½\\n\\
                  \\n\\
                  # ?ì„¸ ë¶„ì„\\n\\
                  - ?¹ì…˜ë³??ì„¸ ë¶„ì„\\n\\
                  - ?œì? ë¦¬ìŠ¤?? ?„ìš”??ê·¸ë˜??ë§í¬ ?¬í•¨ ê°€??\n\\
                  \\n\\
                  # ê²°ë¡  ë°??œì–¸\\n\\
                  - ?°ì´??ê¸°ë°˜??ê²°ë¡ ê³??¥í›„ ì¡°ì¹˜/ì¶”ì²œ ?¬í•­\\n\\
                  \\n\\
                  **ì°¸ê³ **:\\n\\
                  - ??ƒ Markdown ?•ì‹ ?¬ìš© (?¤ë”, ë¦¬ìŠ¤?? ?? ì½”ë“œë¸”ë¡ ??\\n\\
                  - ?”ì•½?€ ì£¼ìš” ?¬ì¸?¸ë? ê°„ê²°?˜ê²Œ\\n\\
                  - ?ì„¸ ë¶„ì„?€ ??ª©ë³„ë¡œ êµ¬ì²´???´ìš©???¬í•¨\\n\\
                  \\n\\
                  ?´ì œ ?¤ìŒ??ì§ˆë¬¸???µë??´ì£¼?¸ìš”.\\n\\
                  {{question}}
                """); // ?¤ì • ê°??¬ìš©

        Prompt prompt = template.apply(Map.of("question", req.getMessage()));

        createEmitter(emitter, convId, reportAgent, prompt.text(), userId);

        return emitter;
    }

    @Async("taskExecutor")
    protected void createEmitter(
            SseEmitter emitter,
            String convId,
            Agent agent,
            String prompt,
            Long userId) {

        try {
            // Agent??chat ë©”ì„œ?œë? ?¸ì¶œ?˜ì—¬ Gemini ëª¨ë¸ê³??í˜¸?‘ìš©?©ë‹ˆ??
            // ?¤íŠ¸ë¦¬ë° ë°©ì‹?¼ë¡œ ?‘ë‹µ??ë°›ìœ¼ë©? ê°?? í°???´ë¼?´ì–¸?¸ì—ê²??„ì†¡?©ë‹ˆ??
            TokenStream tokenStream = agent.chat(prompt, convId);

            // AI ë©”ì‹œì§€ ?„ì  ë²„í¼
            StringBuilder aiBuilder = new StringBuilder();

            // ì²??‘ë‹µ?¼ë¡œ ?€??IDë¥??„ì†¡?©ë‹ˆ??
            emitter.send(SseEmitter.event().name("conversationId").data(convId));

            // ?¤íŠ¸ë¦¬ë° ?‘ë‹µ??ê°?? í°??ì²˜ë¦¬?©ë‹ˆ??
            tokenStream.onNext(token -> {
                        try {
                            aiBuilder.append(token);
                            // ê°?? í°??SSE ?´ë²¤?¸ë¡œ ?´ë¼?´ì–¸?¸ì—ê²??„ì†¡?©ë‹ˆ??
                            emitter.send(SseEmitter.event().data(token));
                        } catch (IOException e) {
                            // ? í° ?„ì†¡ ì¤??¤ë¥˜ ë°œìƒ ??emitterë¥??¤ë¥˜?€ ?¨ê»˜ ?„ë£Œ?©ë‹ˆ??
                            log.error("SSE ? í° ?„ì†¡ ì¤??¤ë¥˜ ë°œìƒ: {}", e.getMessage());
                            emitter.completeWithError(e);
                        }
                    })
                    // ?¤íŠ¸ë¦¬ë° ?„ë£Œ ??AI ë©”ì‹œì§€ ?€?¥ë§Œ ?˜í–‰?©ë‹ˆ??
                    .onComplete(response -> {
                        aiChatService.saveAiMessage(convId, userId, aiBuilder.toString());

                        // ?¤íŠ¸ë¦??•ìƒ ì¢…ë£Œ
                        emitter.complete();

                    })
                    // ?¤íŠ¸ë¦¬ë° ì¤??¤ë¥˜ ë°œìƒ ??emitterë¥??¤ë¥˜?€ ?¨ê»˜ ?„ë£Œ?©ë‹ˆ??
                    .onError(emitter::completeWithError)
                    // ?¤íŠ¸ë¦¬ë°???œì‘?©ë‹ˆ??
                    .start();

        } catch (Exception e) {
            // ?ˆì™¸ ë°œìƒ ??emitterë¥??¤ë¥˜?€ ?¨ê»˜ ?„ë£Œ?©ë‹ˆ??
            log.error("ì±„íŒ… ì²˜ë¦¬ ì¤??¤ë¥˜ ë°œìƒ: {}", e.getMessage(), e);
            emitter.completeWithError(e);
//        } finally {
//            // ?”ì²­ ì²˜ë¦¬ ?„ë£Œ ???¤ë ˆ??ë¡œì»¬???€?¥ëœ ?¬ìš©???•ë³´ë¥??œê±°?©ë‹ˆ??
//            emitter.complete();   // ???¤ê? ?í•œ ê·¸ë?ë¡?? ì?
        }
    }

}
``n

## src/main/java/com/codehows/taelimbe/ai/service/SseService.java

`java

package com.codehows.taelimbe.ai.service;

import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

@Service
public class SseService {

    // conversationId ??emitter ë§¤í•‘
    private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    /**
     * SSE ?°ê²° ?ì„±
     */
    public SseEmitter createEmitter(String conversationId) {
        SseEmitter emitter = new SseEmitter(0L); // ?€?„ì•„???†ìŒ
        emitters.put(conversationId, emitter);

        emitter.onCompletion(() -> emitters.remove(conversationId));
        emitter.onTimeout(() -> emitters.remove(conversationId));
        emitter.onError((e) -> emitters.remove(conversationId));

        return emitter;
    }

    /**
     * SSE ë©”ì‹œì§€ ?„ì†¡
     */
    public void send(String conversationId, String data) {
        SseEmitter emitter = emitters.get(conversationId);
        if (emitter == null) return;

        try {
            emitter.send(SseEmitter.event().data(data));
        } catch (Exception e) {
            emitters.remove(conversationId);
        }
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/controller/AgentController.java

`java

package com.codehows.taelimbe.ai.controller;

import com.codehows.taelimbe.ai.dto.ChatPromptRequest;
import com.codehows.taelimbe.ai.dto.EmbeddingRequest;
import com.codehows.taelimbe.ai.service.AgentService;
import com.codehows.taelimbe.ai.service.SseService;
import com.codehows.taelimbe.ai.service.EmbeddingService;
import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import java.util.UUID;
import java.util.concurrent.CompletableFuture;

@RestController
@RequiredArgsConstructor
@Slf4j
@RequestMapping("/api")   // ?????ë˜ ì½”ë“œ ê·¸ë?ë¡?
public class AgentController {

    private final AgentService agentService;
    private final SseService sseService;
    private final EmbeddingService embeddingService;

    /**
     * ------------------------------------------------------------
     * 1) ë©”ì‹œì§€ ?„ì†¡ (SSE emitter ë°˜í™˜ X)
     * POST /api/agent/chat
     * ------------------------------------------------------------
     */
//    @PostMapping("/agent/chat")
//    public ResponseEntity<String> chat(
//            @RequestBody ChatPromptRequest req,
//            HttpServletRequest request
//    ) {
//        Long userId = Long.valueOf(request.getAttribute("userId").toString());
//
//        String conversationId = req.getConversationId();
//        if (conversationId == null || conversationId.isBlank()) {
//            conversationId = UUID.randomUUID().toString();
//        }
//
//        agentService.process(conversationId, req.getMessage(), userId);
//
//        return ResponseEntity.ok(conversationId);
//    }
    @PostMapping("/agent/chat")
    public ResponseEntity<String> chat(
            @RequestBody ChatPromptRequest req,
            HttpServletRequest request
    ) {

        // ??ì¶”ê???ë¡œê·¸ ????ì½”ë“œ ê·¸ë?ë¡?? ì?
        log.info("?” [chat] request.getAttribute(\"userId\") = {}", request.getAttribute("userId"));
        log.info("?” [chat] req.getConversationId() = {}", req.getConversationId());
        log.info("?” [chat] req.getMessage() = {}", req.getMessage());

        Long userId = Long.valueOf(request.getAttribute("userId").toString());
        log.info("?” [chat] parsed userId = {}", userId);

        String conversationId = req.getConversationId();
        log.info("?” [chat] incoming conversationId = {}", conversationId);
        if (conversationId == null || conversationId.isBlank()) {
            conversationId = UUID.randomUUID().toString();

            // ???¬ê¸°ë§?ì¶”ê?
            log.info("?” [chat] generated new conversationId = {}", conversationId);
        }
        log.info("?” [chat] calling agentService.process()");
        agentService.process(conversationId, req.getMessage(), userId);

        return ResponseEntity.ok(conversationId);
    }


    /**
     * ------------------------------------------------------------
     * 2) SSE ?°ê²°
     * GET /api/agent/stream/{conversationId}
     * ------------------------------------------------------------
     */
    @GetMapping(value = "/agent/stream/{conversationId}", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter connect(@PathVariable String conversationId) {
        return sseService.createEmitter(conversationId);
    }

    /**
     * ------------------------------------------------------------
     * 3) ë¦¬í¬???ì„± (SSE ì§ì ‘ ë°˜í™˜)
     * POST /api/agent/report
     * ------------------------------------------------------------
     */
    @PostMapping(value = "/agent/report", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter report(
            @RequestBody ChatPromptRequest req,
            HttpServletRequest request
    ) {
        Long userId = Long.valueOf(request.getAttribute("userId").toString());
        return agentService.report(req, userId);
    }

    /**
     * ------------------------------------------------------------
     * 4) Embedding ì²˜ë¦¬
     * POST /api/embeddings
     * ------------------------------------------------------------
     */
    @PostMapping("/embeddings")
    public CompletableFuture<ResponseEntity<String>> embed(
            @RequestBody EmbeddingRequest request
    ) {
        return embeddingService.embedAndStore(request.getText())
                .thenApply(v -> ResponseEntity.ok("Embedding started"))
                .exceptionally(ex -> {
                    log.error("embed error", ex);
                    return ResponseEntity.internalServerError().body(ex.getMessage());
                });
    }

    /**
     * ------------------------------------------------------------
     * 5) Embedding ë¦¬ì…‹
     * POST /api/embeddings/reset
     * ------------------------------------------------------------
     */
    @PostMapping("/embeddings/reset")
    public CompletableFuture<ResponseEntity<String>> resetAndEmbed(
            @RequestBody EmbeddingRequest request
    ) {
        return embeddingService.resetAndEmbed(request.getText())
                .thenApply(v -> ResponseEntity.ok("Reset + embedding started"))
                .exceptionally(ex -> {
                    log.error("reset embed error", ex);
                    return ResponseEntity.internalServerError().body(ex.getMessage());
                });
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/service/AiChatService.java

`java

package com.codehows.taelimbe.ai.service;

import com.codehows.taelimbe.ai.constant.SenderType;
import com.codehows.taelimbe.ai.dto.AiChatDTO;
import com.codehows.taelimbe.ai.entity.AiChat;
import com.codehows.taelimbe.ai.repository.AiChatRepository;
import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional
@Slf4j
public class AiChatService {

    private final AiChatRepository aiChatRepository;
    private final UserRepository userRepository;

    // ?„ì¬ ë¡œê·¸?¸í•œ ?¬ìš©???•ë³´ ê°€?¸ì˜¤ê¸?
    private User getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        return userRepository.findById(username)
                .orElseThrow(() -> new RuntimeException("?¬ìš©?ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤: " + username));
    }


    /**
     * AI ?‘ë‹µ ë©”ì‹œì§€ ?€??
     */
    public AiChat saveAgentMessage(String conversationId, String response) {
        User user = getCurrentUser();
        Long nextMessageIndex = aiChatRepository.findMaxMessageIndexByConversationId(conversationId) + 1;

        AiChat agentChat = AiChat.builder()
                .conversationId(conversationId)
                .senderType(SenderType.AI)
                .rawMessage(response)
                .messageIndex(nextMessageIndex)
                .user(user)
                .createdAt(LocalDateTime.now())
                .build();

        return aiChatRepository.save(agentChat);
    }

    /**
     * ?¹ì • ?€?”ì˜ ëª¨ë“  ë©”ì‹œì§€ ì¡°íšŒ
     */
    @Transactional(readOnly = true)
    public List<AiChatDTO> getChatHistory(String conversationId) {
        return aiChatRepository.findByConversationIdOrderByMessageIndex(conversationId)
                .stream()
                .map(AiChatDTO::from)
                .collect(Collectors.toList());
    }

    /**
     * ?¬ìš©?ì˜ ?€??ëª©ë¡ ì¡°íšŒ (ìµœì‹ ??
     * ê°??€?”ì˜ ì²?ë²ˆì§¸ ë©”ì‹œì§€ë¥??€???œëª©?¼ë¡œ ?¬ìš©
     */
    @Transactional(readOnly = true)
    public List<AiChatDTO> getUserChatList() {
        User user = getCurrentUser();
        List<String> conversationIds = aiChatRepository.findConversationIdsByUserId(user.getUserId());

        // ?€???ì²´ê°€ ?˜ë‚˜???†ìœ¼ë©?ë¹?ë°°ì—´ ë°˜í™˜
        if (conversationIds == null || conversationIds.isEmpty()) {
            return Collections.emptyList();
        }

        return conversationIds.stream()
                .map(convId -> {
                    List<AiChat> messages = aiChatRepository.findByConversationIdOrderByMessageIndex(convId);

                    // ë©”ì‹œì§€ê°€ ?˜ë‚˜???†ìœ¼ë©?null ê²°ê³¼ ?€??skip
                    if (messages == null || messages.isEmpty()) {
                        return null; // ???¤ì— filterë¡?ê±¸ëŸ¬ì§?
                    }

                    AiChat firstMessage = messages.stream()
                            .filter(msg -> msg.getSenderType() == SenderType.USER)
                            .findFirst()
                            .orElse(messages.get(0)); // ?´ì œ ?ˆì „??(messagesê°€ empty ?„ë‹Œ ?íƒœë¡??¤ì–´?¤ê¸° ?Œë¬¸)

                    return AiChatDTO.from(firstMessage);
                })
                .filter(Objects::nonNull)
                .collect(Collectors.toList());
    }


    /**
     * ?¹ì • ë§¤ì¥??ëª¨ë“  ?€??ì¡°íšŒ (ê´€ë¦¬ì??
     */
    @Transactional(readOnly = true)
    public List<AiChatDTO> getStoreChatHistory(Long storeId) {
        return aiChatRepository.findByStoreIdOrderByCreatedAtDesc(storeId)
                .stream()
                .map(AiChatDTO::from)
                .collect(Collectors.toList());
    }

    /**
     * ?€??ë©”ì‹œì§€ ?? œ (?€???„ì²´ ?? œ)
     */
    public void deleteConversation(String conversationId) {
        List<AiChat> chats = aiChatRepository.findByConversationIdOrderByMessageIndex(conversationId);
        aiChatRepository.deleteAll(chats);
        log.info("?€??'{}' ?? œ ?„ë£Œ", conversationId);
    }

    /**
     * ?¹ì • ë©”ì‹œì§€ ?? œ
     */
    public void deleteChatMessage(Long aiChatId) {
        aiChatRepository.deleteById(aiChatId);
        log.info("ë©”ì‹œì§€ '{}' ?? œ ?„ë£Œ", aiChatId);
    }

    /** USER ë©”ì‹œì§€ ?€??*/
    public void saveUserMessage(String convId, Long userId, String msg) {

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("User not found"));

        long idx = aiChatRepository.countByConversationId(convId);

        AiChat chat = AiChat.builder()
                .conversationId(convId)
                .senderType(SenderType.USER)
                .rawMessage(msg)
                .messageIndex(idx)
                .user(user)
                .build();

        aiChatRepository.save(chat);
    }

    /** AI ë©”ì‹œì§€ ?€??*/
    public void saveAiMessage(String convId, Long userId, String msg) {

        User user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("User not found"));

        long idx = aiChatRepository.countByConversationId(convId);

        AiChat chat = AiChat.builder()
                .conversationId(convId)
                .senderType(SenderType.AI)
                .rawMessage(msg)
                .messageIndex(idx)
                .user(user)
                .build();

        aiChatRepository.save(chat);
    }

    public List<AiChat> loadConversation(String convId) {
        return aiChatRepository.findByConversationIdOrderByMessageIndexAsc(convId);
    }

    public List<String> loadChatHistory(Long userId) {
        return aiChatRepository.findConversationIdsByUser(userId);
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/repository/AiChatRepository.java

`java

package com.codehows.taelimbe.ai.repository;

import com.codehows.taelimbe.ai.entity.AiChat;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface AiChatRepository extends JpaRepository<AiChat, Long> {

    // ?¹ì • ?€?”ì˜ ëª¨ë“  ë©”ì‹œì§€ ì¡°íšŒ (ë©”ì‹œì§€ ?œì„œ?€ë¡?
    List<AiChat> findByConversationIdOrderByMessageIndex(String conversationId);

    // ?¹ì • ?¬ìš©?ì˜ ëª¨ë“  ?€??ì¡°íšŒ
    List<AiChat> findByUser_UserIdOrderByCreatedAtDesc(Long userId);

    // ?¹ì • ë§¤ì¥??ëª¨ë“  ?€??ì¡°íšŒ
    @Query("SELECT c FROM AiChat c WHERE c.user.store.storeId = :storeId ORDER BY c.createdAt DESC")
    List<AiChat> findByStoreIdOrderByCreatedAtDesc(@Param("storeId") Long storeId);

    // ?¹ì • ?€?”ì˜ ë§ˆì?ë§?ë©”ì‹œì§€ ?¸ë±??ì¡°íšŒ
    @Query("SELECT COALESCE(MAX(c.messageIndex), 0) FROM AiChat c WHERE c.conversationId = :conversationId")
    Long findMaxMessageIndexByConversationId(@Param("conversationId") String conversationId);

    @Query("""
    SELECT c.conversationId
    FROM AiChat c
    WHERE c.user.userId = :userId
    GROUP BY c.conversationId
    ORDER BY MAX(c.createdAt) DESC
""")
    List<String> findConversationIdsByUserId(@Param("userId") Long userId);


    List<AiChat> findByConversationIdOrderByMessageIndexAsc(String conversationId);

    @Query("SELECT DISTINCT a.conversationId FROM AiChat a WHERE a.user.userId = :userId")
    List<String> findConversationIdsByUser(@Param("userId") Long userId);

    long countByConversationId(String conversationId);
}
``n

## src/main/java/com/codehows/taelimbe/ai/service/EmbeddingService.java

`java

package com.codehows.taelimbe.ai.service;

import com.codehows.taelimbe.langchain.embaddings.EmbeddingStoreManager;
import com.codehows.taelimbe.langchain.embaddings.TextSplitterStrategy;
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.model.output.Response;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.task.TaskExecutor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.concurrent.CompletableFuture;

/**
 * ?ìŠ¤???„ë² ??ë°?ë²¡í„° ?€?¥ì†Œ ê´€ë¦¬ë? ?´ë‹¹?˜ëŠ” ?œë¹„?¤ì…?ˆë‹¤.
 * `@Service` ?´ë…¸?Œì´?˜ì? ???´ë˜?¤ê? ë¹„ì¦ˆ?ˆìŠ¤ ê³„ì¸µ??ì»´í¬?ŒíŠ¸?„ì„ ?˜í??´ë©°,
 * Spring ì»¨í…Œ?´ë„ˆ???˜í•´ ê´€ë¦¬ë˜??ë¹ˆìœ¼ë¡??±ë¡?©ë‹ˆ??
 * `@RequiredArgsConstructor`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? final ?„ë“œ???€???ì„±?ë? ?ë™?¼ë¡œ ?ì„±?˜ì—¬ ?˜ì¡´??ì£¼ì…???©ì´?˜ê²Œ ?©ë‹ˆ??
 * `@Slf4j`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? ë¡œê¹…???„í•œ `log` ê°ì²´ë¥??ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class EmbeddingService {

    // ?ìŠ¤?¸ë? ?„ë² ??ë²¡í„°ë¡?ë³€?˜í•˜??ëª¨ë¸??ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    private final EmbeddingModel embeddingModel;
    // ?ì„±???„ë² ??ë²¡í„°ë¥??€?¥í•˜ê³?ê²€?‰í•˜???¤í† ?´ë? ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    private final EmbeddingStore<TextSegment> embeddingStore;
    // ?„ë² ???¤í† ?´ì˜ ì´ˆê¸°??ë°?ê´€ë¦?ê¸°ëŠ¥???œê³µ?˜ëŠ” ë§¤ë‹ˆ?€ë¥?ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    private final EmbeddingStoreManager embeddingStoreManager;
    // ?ìŠ¤??ë¶„í•  ?„ëµ??ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    private final TextSplitterStrategy textSplitterStrategy;

    // ë¹„ë™ê¸??‘ì—…???„í•œ ?¤ë ˆ???€??ì£¼ì…ë°›ìŠµ?ˆë‹¤.
    @Qualifier("taskExecutor")
    private final TaskExecutor taskExecutor;

    /**
     * ì£¼ì–´ì§??ìŠ¤?¸ë? ?„ë² ?©í•˜??ë²¡í„° ?€?¥ì†Œ??ì¶”ê??©ë‹ˆ??
     * ??ë©”ì„œ?œëŠ” RAG(Retrieval-Augmented Generation)ë¥??„í•œ ì§€??ê¸°ë°˜??êµ¬ì¶•?˜ëŠ” ???¬ìš©?©ë‹ˆ??
     * ?‘ì—…?€ ë¹„ë™ê¸°ì ?¼ë¡œ ?¤í–‰?˜ì–´ ?¸ì¶œ ?¤ë ˆ?œë? ë¸”ë¡œ?¹í•˜ì§€ ?ŠìŠµ?ˆë‹¤.
     *
     * @param text ?„ë² ?©í•˜ê³??€?¥í•  ?ìŠ¤??
     * @return ë¹„ë™ê¸??‘ì—…???„ë£Œë¥??˜í??´ëŠ” `CompletableFuture<Void>`
     */
//    public CompletableFuture<Void> embedAndStore(String text) {
//        return CompletableFuture.runAsync(() -> {
//            log.info("?ìŠ¤???„ë² ??ë°??€???œì‘: '{}'", text);
//
//            // 1. ?ìŠ¤??ë¶„í•  ?„ëµ???¬ìš©?˜ì—¬ ?ìŠ¤?¸ë? ?‘ì? `TextSegment`?¤ë¡œ ë¶„í• ?©ë‹ˆ??
//            List<TextSegment> segments = textSplitterStrategy.split(text).stream().map(TextSegment::from).toList();
//
//            // 2. `EmbeddingModel`???¬ìš©?˜ì—¬ ê°?`TextSegment`ë¥??„ë² ??ë²¡í„°ë¡?ë³€?˜í•©?ˆë‹¤.
//            Response<List<Embedding>> embedding = embeddingModel.embedAll(segments);
//
//            // 3. ?„ë² ?©ëœ `TextSegment`?€ ?´ë‹¹ ?„ë² ??ë²¡í„°ë¥?`EmbeddingStore`??ì¶”ê??©ë‹ˆ??
//            embeddingStore.addAll(embedding.content(), segments);
//
//            log.info("?ìŠ¤???„ë² ??ë°??€???„ë£Œ.");
//        }, taskExecutor); // ì§€?•ëœ `taskExecutor` ?¤ë ˆ???€?ì„œ ?¤í–‰
//    }

    public CompletableFuture<Void> embedAndStore(String text) {
        return CompletableFuture.runAsync(() -> {
            log.info("?ìŠ¤???„ë² ??ë°??€???œì‘: '{}'", text);

            try {
                // 1. ?ìŠ¤??ë¶„í• 
                List<TextSegment> segments = textSplitterStrategy
                        .split(text)
                        .stream()
                        .map(TextSegment::from)
                        .toList();

                log.info("Segments size = {}", segments.size());
                if (segments.isEmpty()) {
                    log.warn("??ë¶„í• ???¸ê·¸ë¨¼íŠ¸ê°€ ?†ìŠµ?ˆë‹¤. ì²˜ë¦¬ ì¤‘ë‹¨.");
                    return;
                }

                // 2. ?„ë² ???˜í–‰
                Response<List<Embedding>> embedding = embeddingModel.embedAll(segments);
                log.info("Embedding size = {}", embedding.content().size());

                // 3. ?„ë² ???¤í† ?´ì— ?€??
                embeddingStore.addAll(embedding.content(), segments);

            } catch (Exception e) {
                log.error("???„ë² ??ì¤??¤ë¥˜ ë°œìƒ!", e);
                throw new RuntimeException(e);
            }

            log.info("?ìŠ¤???„ë² ??ë°??€???„ë£Œ.");
        }, taskExecutor);
    }


    /**
     * ê¸°ì¡´ ë²¡í„° ?€?¥ì†Œ??ëª¨ë“  ?°ì´?°ë? ?? œ?˜ê³ , ì£¼ì–´ì§??ìŠ¤?¸ë¡œ ?ˆë¡œ ?„ë² ?©í•˜???€?¥í•©?ˆë‹¤.
     * ì§€??ê¸°ë°˜???„ì „??ì´ˆê¸°?”í•˜ê³??ˆë¡œ???°ì´?°ë¡œ êµì²´?????¬ìš©?©ë‹ˆ??
     * ?‘ì—…?€ ë¹„ë™ê¸°ì ?¼ë¡œ ?¤í–‰?˜ì–´ ?¸ì¶œ ?¤ë ˆ?œë? ë¸”ë¡œ?¹í•˜ì§€ ?ŠìŠµ?ˆë‹¤.
     *
     * @param text ?ˆë¡œ ?„ë² ?©í•˜ê³??€?¥í•  ?ìŠ¤??
     * @return ë¹„ë™ê¸??‘ì—…???„ë£Œë¥??˜í??´ëŠ” `CompletableFuture<Void>`
     */
    public CompletableFuture<Void> resetAndEmbed(String text) {
        return CompletableFuture.runAsync(() -> {
            log.info("?„ë² ???¤í† ???¬ì„¤??ë°????ìŠ¤???„ë² ???œì‘.");

            // 1. `EmbeddingStoreManager`ë¥??¬ìš©?˜ì—¬ Milvus ì»¬ë ‰?˜ì„ ?¬ì„¤???? œ ???¬ìƒ???©ë‹ˆ??
            embeddingStoreManager.reset();

            // 2. ?ˆë¡œ???ìŠ¤?¸ë¡œ ?„ë² ??ë°??€?¥ì„ ?˜í–‰?©ë‹ˆ??
            embedAndStore(text);

            log.info("?„ë² ???¤í† ???¬ì„¤??ë°????ìŠ¤???„ë² ???„ë£Œ.");
        }, taskExecutor); // ì§€?•ëœ `taskExecutor` ?¤ë ˆ???€?ì„œ ?¤í–‰
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/controller/AiChatController.java

`java

package com.codehows.taelimbe.ai.controller;

import com.codehows.taelimbe.ai.dto.AiChatDTO;
import com.codehows.taelimbe.ai.service.AiChatService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Slf4j
@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class AiChatController {

    private final AiChatService aiChatService;
    /**
     * ?¬ìš©?ì˜ ?€??ëª©ë¡ ì¡°íšŒ (?¬ì´?œë°”?ì„œ ?¬ìš©)
     * ê°??€?”ì˜ ì²?ë²ˆì§¸ ë©”ì‹œì§€ (?¬ìš©??ì§ˆë¬¸)ë¥??œëª©?¼ë¡œ ë°˜í™˜
     */
    @GetMapping("/chat/history")
    public ResponseEntity<List<AiChatDTO>> getChatHistory() {
        List<AiChatDTO> chatList = aiChatService.getUserChatList();
        return ResponseEntity.ok(chatList);
    }

    /**
     * ?¹ì • ?€?”ì˜ ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ
     */
    @GetMapping("/conversation/{conversationId}")
    public ResponseEntity<List<AiChatDTO>> getConversationMessages(
            @PathVariable String conversationId) {
        List<AiChatDTO> messages = aiChatService.getChatHistory(conversationId);
        return ResponseEntity.ok(messages);
    }

    /**
     * ?€???? œ
     */
    @DeleteMapping("/conversation/{conversationId}")
    public ResponseEntity<String> deleteConversation(
            @PathVariable String conversationId) {
        try {
            aiChatService.deleteConversation(conversationId);
            return ResponseEntity.ok("?€?”ê? ?? œ?˜ì—ˆ?µë‹ˆ??");
        } catch (Exception e) {
            log.error("?€???? œ ?¤íŒ¨: {}", e.getMessage());
            return ResponseEntity.internalServerError()
                    .body("?€???? œ ì¤??¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");
        }
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/config/AsyncConfig.java

`java

package com.codehows.taelimbe.ai.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.task.TaskExecutor;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
import org.springframework.security.task.DelegatingSecurityContextAsyncTaskExecutor;

import java.util.concurrent.ThreadPoolExecutor;

/**
 * ? í”Œë¦¬ì??´ì…˜??ë¹„ë™ê¸??‘ì—…???„í•œ ì¤‘ì•™ ?¤ë ˆ???€???¤ì •?˜ëŠ” ?´ë˜?¤ì…?ˆë‹¤.
 * `@Configuration` ?´ë…¸?Œì´?˜ì? ???´ë˜?¤ê? Spring???¤ì • ?´ë˜?¤ì„???˜í??´ë©°,
 * Spring ì»¨í…Œ?´ë„ˆê°€ ???´ë˜?¤ì—???•ì˜??`@Bean` ë©”ì„œ?œë? ?µí•´ ë¹ˆì„ ?ì„±?˜ë„ë¡?ì§€?œí•©?ˆë‹¤.
 */
@Configuration
@EnableAsync
public class AsyncConfig {

    /**
     * ë¹„ë™ê¸??‘ì—…??ì²˜ë¦¬?˜ê¸° ?„í•œ `TaskExecutor` Bean???ì„±?©ë‹ˆ??
     * ??`TaskExecutor`??`@Async` ?´ë…¸?Œì´?˜ì´ ë¶™ì? ë©”ì„œ?œë? ?¤í–‰?˜ëŠ” ???¬ìš©?????ˆìŠµ?ˆë‹¤.
     * `TaskDecorator`ë¥??¬ìš©?˜ì—¬ `UserContextHolder`??ì»¨í…?¤íŠ¸ë¥?ë¹„ë™ê¸??¤ë ˆ?œë¡œ ?„íŒŒ?©ë‹ˆ??
     *
     * @return ?¤ì •???„ë£Œ??`ThreadPoolTaskExecutor` ?¸ìŠ¤?´ìŠ¤
     */
    @Bean("taskExecutor")
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        // ì½”ì–´ ?¤ë ˆ???€???¬ê¸°ë¥??¤ì •?©ë‹ˆ?? ???˜ë§Œ?¼ì˜ ?¤ë ˆ?œê? ??ƒ ? ì??©ë‹ˆ??
        executor.setCorePoolSize(10);
        // ìµœë? ?¤ë ˆ???€???¬ê¸°ë¥??¤ì •?©ë‹ˆ?? ì½”ì–´ ?€??ê°€??ì°¨ê³  ?ë„ ê°€??ì°¼ì„ ???ì„±?????ˆëŠ” ìµœë? ?¤ë ˆ???˜ì…?ˆë‹¤.
        executor.setMaxPoolSize(20);
        // ?‘ì—… ?ì˜ ?©ëŸ‰???¤ì •?©ë‹ˆ?? ì½”ì–´ ?€???¤ë ˆ?œê? ëª¨ë‘ ?¬ìš© ì¤‘ì¼ ???‘ì—…???€ê¸°í•˜??ê³µê°„?…ë‹ˆ??
        executor.setQueueCapacity(50);
        // ê±°ë? ?•ì±…???¤ì •?©ë‹ˆ?? ?ê¹Œì§€ ê°€??ì°¼ì„ ???ˆë¡œ???‘ì—…???¤ì–´?¤ë©´ ?¸ì¶œ???¤ë ˆ?œê? ì§ì ‘ ?‘ì—…???¤í–‰?©ë‹ˆ??
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        // ?ì„±?˜ëŠ” ?¤ë ˆ?œì˜ ?´ë¦„ ?‘ë‘?¬ë? ?¤ì •?˜ì—¬ ë¡œê·¸?ì„œ ?¤ë ˆ?œë? ?½ê²Œ ?ë³„?????ˆë„ë¡??©ë‹ˆ??
        executor.setThreadNamePrefix("async-task-");
        // Executorë¥?ì´ˆê¸°?”í•©?ˆë‹¤.
        executor.initialize();

        return new DelegatingSecurityContextAsyncTaskExecutor(executor);
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/constant/SenderType.java

`java

package com.codehows.taelimbe.ai.constant;

/**
 * AI ì±„íŒ…?ì„œ ë©”ì‹œì§€ë¥?ë³´ë‚¸ ì£¼ì²´ë¥??˜í??´ëŠ” Enum
 * USER: ?¤ì œ ?¬ìš©??Role.USER, Role.MANAGER, Role.ADMIN ëª¨ë‘ ?¬í•¨)ê°€ ë³´ë‚¸ ë©”ì‹œì§€
 * AI: AI ?ì´?„íŠ¸(Gemini)ê°€ ë³´ë‚¸ ?‘ë‹µ
 */
public enum SenderType {
    USER("?¬ìš©??),
    AI("AI");

    private final String description;

    SenderType(String description) {
        this.description = description;
    }

    public String getDescription() {
        return description;
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/controller/AiReportController.java

`java

package com.codehows.taelimbe.ai.controller;

import com.codehows.taelimbe.ai.dto.AiReportDTO;
import com.codehows.taelimbe.ai.service.AiReportService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@RestController
@RequestMapping("")  // /api ?œê±°
@RequiredArgsConstructor
public class AiReportController {

    private final AiReportService aiReportService;

    @GetMapping("/aiReport")  // ?¤ì œ ê²½ë¡œ: /aiReport
    @ResponseBody
    public ResponseEntity<List<AiReportDTO>> getAllReports() {
        List<AiReportDTO> reports = aiReportService.getAllReports();
        return ResponseEntity.ok(reports);
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/dto/AiChatDTO.java

`java

package com.codehows.taelimbe.ai.dto;

import com.codehows.taelimbe.ai.constant.SenderType;
import com.codehows.taelimbe.ai.entity.AiChat;
import lombok.*;

import java.time.LocalDateTime;

@Builder
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class AiChatDTO {

    private Long aiChatId;
    private String conversationId;
    private SenderType senderType;
    private String rawMessage;
    private LocalDateTime createdAt;
    private Long messageIndex;
    private Long userId;
    private String userName;

    /**
     * Entityë¥?DTOë¡?ë³€??
     */
    public static AiChatDTO from(AiChat aiChat) {
        return AiChatDTO.builder()
                .aiChatId(aiChat.getAiChatId())
                .conversationId(aiChat.getConversationId())
                .senderType(aiChat.getSenderType())
                .rawMessage(aiChat.getRawMessage())
                .createdAt(aiChat.getCreatedAt())
                .messageIndex(aiChat.getMessageIndex())
                .userId(aiChat.getUser() != null ? aiChat.getUser().getUserId() : null)
                .userName(aiChat.getUser() != null ? aiChat.getUser().getName() : null)
                .build();
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/dto/AiReportDTO.java

`java

package com.codehows.taelimbe.ai.dto;

import com.codehows.taelimbe.ai.entity.AiReport;
import lombok.*;

import java.time.LocalDateTime;

@Builder
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
public class AiReportDTO {

    private Long aiReportId;
    private String conversationId;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private LocalDateTime createdAt;
    private String rawMessage;
    private String rawReport;
    private Long userId;
    private String name; // ?ˆë¡œ ì¶”ê?

    public static AiReportDTO from(AiReport aiReport) {
        return AiReportDTO.builder()
                .aiReportId(aiReport.getAiReportId())
                .conversationId(aiReport.getConversationId())
                .startTime(aiReport.getStartTime())
                .endTime(aiReport.getEndTime())
                .createdAt(aiReport.getCreatedAt())
                .rawMessage(aiReport.getRawMessage())
                .rawReport(aiReport.getRawReport())
                .userId(aiReport.getUser() != null ? aiReport.getUser().getUserId() : null)
                .name(aiReport.getUser() != null ? aiReport.getUser().getName() : null)
                .build();
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/dto/ChatPromptRequest.java

`java

package com.codehows.taelimbe.ai.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * ì±„íŒ… ?„ë¡¬?„íŠ¸ ?”ì²­???„í•œ ?°ì´???„ì†¡ ê°ì²´(DTO)?…ë‹ˆ??
 * ?´ë¼?´ì–¸?¸ë¡œë¶€??AI ?ì´?„íŠ¸?ê²Œ ?„ë‹¬??ë©”ì‹œì§€?€ ?€??IDë¥?ìº¡ìŠ?”í•©?ˆë‹¤.
 *
 * `@Data`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? `@Getter`, `@Setter`, `@EqualsAndHashCode`, `@ToString`???ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 * `@NoArgsConstructor`???¸ì ?†ëŠ” ê¸°ë³¸ ?ì„±?ë? ?ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 * `@AllArgsConstructor`??ëª¨ë“  ?„ë“œë¥??¸ìë¡?ë°›ëŠ” ?ì„±?ë? ?ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ChatPromptRequest {
    /**
     * ?¬ìš©?ë¡œë¶€??AI ?ì´?„íŠ¸?ê²Œ ?„ë‹¬??ë©”ì‹œì§€?…ë‹ˆ??
     */
    private String message;
    /**
     * ?„ì¬ ?€?”ì˜ ê³ ìœ  ID?…ë‹ˆ??
     * ??IDë¥??µí•´ AI ?ì´?„íŠ¸ê°€ ?´ì „ ?€?”ì˜ ì»¨í…?¤íŠ¸ë¥?? ì??????ˆìŠµ?ˆë‹¤.
     */
    private String conversationId;
}
``n

## src/main/java/com/codehows/taelimbe/ai/dto/EmbeddingRequest.java

`java

package com.codehows.taelimbe.ai.dto;

import lombok.Data;

/**
 * ?„ë² ???ì„±???„í•œ ?”ì²­ ?°ì´???„ì†¡ ê°ì²´(DTO)?…ë‹ˆ??
 * ?„ë² ?©ì„ ?ì„±???ìŠ¤???°ì´?°ë? ìº¡ìŠ?”í•©?ˆë‹¤.
 *
 * `@Data`??Lombok ?´ë…¸?Œì´?˜ìœ¼ë¡? `@Getter`, `@Setter`, `@EqualsAndHashCode`, `@ToString`???ë™?¼ë¡œ ?ì„±?©ë‹ˆ??
 */
@Data
public class EmbeddingRequest {
    /**
     * ?„ë² ?©ì„ ?ì„±???ë³¸ ?ìŠ¤?¸ì…?ˆë‹¤.
     */
    private String text;
}
``n

## src/main/java/com/codehows/taelimbe/ai/entity/AiChat.java

`java

package com.codehows.taelimbe.ai.entity;

import com.codehows.taelimbe.ai.constant.SenderType;
import com.codehows.taelimbe.user.entity.User;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "ai_chat")
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class AiChat {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ai_chat_id")
    private Long aiChatId;

    @Column(name = "conversation_id", length = 50, nullable = false)
    private String conversationId;

    @Enumerated(EnumType.STRING)
    @Column(name = "sender_type", nullable = false)
    private SenderType senderType;

    @Column(name = "raw_message", columnDefinition = "LONGTEXT", nullable = false)
    private String rawMessage;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "message_index", nullable = false)
    private Long messageIndex;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User user;

    // ?”í‹°???ì„± ???ë™?¼ë¡œ ?ì„± ?œê°„ ?¤ì •
    @PrePersist
    protected void onCreate() {
        if (this.createdAt == null) {
            this.createdAt = LocalDateTime.now();
        }
    }
}
``n

## src/main/java/com/codehows/taelimbe/ai/entity/AiReport.java

`java

package com.codehows.taelimbe.ai.entity;

import com.codehows.taelimbe.user.entity.User;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "ai_report")
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class AiReport {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ai_report_id")
    private Long aiReportId;

    @Column(name = "conversation_id", length = 10)
    private String conversationId;

    @Column(name = "start_time")
    private LocalDateTime startTime;

    @Column(name = "end_time")
    private LocalDateTime endTime;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "raw_message", columnDefinition = "TEXT")
    private String rawMessage;

    @Column(name = "raw_report", columnDefinition = "TEXT")
    private String rawReport;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

}
``n

## src/main/java/com/codehows/taelimbe/ai/repository/AiReportRepository.java

`java

package com.codehows.taelimbe.ai.repository;

import com.codehows.taelimbe.ai.entity.AiReport;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface AiReportRepository extends JpaRepository<AiReport, Long> {

    // ?¹ì • Userë¡?ì¡°íšŒ
    List<AiReport> findByUser_UserId(Long userId);

    // ?¹ì • Store??ëª¨ë“  ë¦¬í¬??ì¡°íšŒ (ìµœì‹ ??
    @Query("SELECT a FROM AiReport a WHERE a.user.store.storeId = :storeId ORDER BY a.createdAt DESC")
    List<AiReport> findByStoreIdOrderByCreatedAtDesc(@Param("storeId") Long storeId);

    // ëª¨ë“  ë¦¬í¬??ì¡°íšŒ (ADMIN??- ìµœì‹ ??
    List<AiReport> findAllByOrderByCreatedAtDesc();
}
``n

## src/main/java/com/codehows/taelimbe/ai/service/AiReportService.java

`java

package com.codehows.taelimbe.ai.service;

import com.codehows.taelimbe.ai.dto.AiReportDTO;
import com.codehows.taelimbe.ai.repository.AiReportRepository;
import com.codehows.taelimbe.user.constant.Role;
import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class AiReportService {

    private final AiReportRepository aiReportRepository;
    private final UserRepository userRepository;

    // ?„ì¬ ë¡œê·¸?¸í•œ ? ì? ?•ë³´ ê°€?¸ì˜¤ê¸?
    private User getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        return userRepository.findById(username)
                .orElseThrow(() -> new RuntimeException("?¬ìš©?ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤"));
    }

    // ?„ì²´ ë¦¬í¬??ì¡°íšŒ (ê¶Œí•œ???°ë¼ ?„í„°ë§?
    public List<AiReportDTO> getAllReports() {
        User currentUser = getCurrentUser();

        // ADMIN: ëª¨ë“  ë¦¬í¬??ì¡°íšŒ
        if (currentUser.getRole() == Role.ADMIN) {
            return aiReportRepository.findAllByOrderByCreatedAtDesc()
                    .stream()
                    .map(AiReportDTO::from)
                    .collect(Collectors.toList());
        }

        // MANAGER, EMPLOYEE: ?ê¸° ë§¤ì¥ ë¦¬í¬?¸ë§Œ ì¡°íšŒ
        Long storeId = currentUser.getStore().getStoreId();
        return aiReportRepository.findByStoreIdOrderByCreatedAtDesc(storeId)
                .stream()
                .map(AiReportDTO::from)
                .collect(Collectors.toList());
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/config/JwtFilter.java

`java

package com.codehows.taelimbe.user.config;

import com.codehows.taelimbe.user.service.JwtService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.Servlet;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpHeaders;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Slf4j
@Component
@RequiredArgsConstructor
public class JwtFilter extends OncePerRequestFilter
{
    private final JwtService jwtService;
    private final Servlet servlet;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {

        // OPTIONS ?”ì²­(Preflight)?€ JWT ê²€ì¦??†ì´ ë°”ë¡œ ?µê³¼
        if ("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            filterChain.doFilter(request, response);
            return;
        }

        // ?„í„° ==> ?”ì²­, ?‘ë‹µ??ì¤‘ê°„?ì„œ ê°€ë¡œì±ˆ ?¤ìŒ ==> ?„ìš”???™ì‘???˜í–‰
        // 1. ?”ì²­ ?¤ë” (Authorization)?ì„œ JWT ? í°??êº¼ëƒ„
        String jwtToken = request.getHeader(HttpHeaders.AUTHORIZATION);
        log.info("?” [JWT] Authorization = {}", jwtToken);//?˜ì¤‘??ì§€?¸ê±°


        if (jwtToken != null)
        {
            // 2. êº¼ë‚¸ ? í°?ì„œ ? ì? ?•ë³´ ì¶”ì¶œ
            String id = jwtService.parseToken(request);
            log.info("?” [JWT] parsedTokenUserId = {}", id);//?˜ì¤‘??ì§€?¸ê±°

            // 2) userId(claim) ì¶”ì¶œ
            Long userId = jwtService.extractUserId(jwtToken);

            // 3. ì¶”ì¶œ??? ì? ?•ë³´ë¡?Authentication ??ë§Œë“¤?´ì„œ SecurityContext??set
            if(id != null)
            {
                Authentication authentication =
                        new UsernamePasswordAuthenticationToken(id, null, Collections.emptyList());
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }

            // Controller ?ì„œ userId ?¬ìš©?????ˆë„ë¡??€??
            request.setAttribute("userId", userId);
            log.info("?” [JWT] request.setAttribute userId = {}", request.getAttribute("userId")); //?˜ì¤‘??ì§€?¸ê±°

        }
        // ë§ˆì?ë§‰ì— ?¤ìŒ ?„í„°ë¥??¸ì¶œ
        filterChain.doFilter(request, response);
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/config/SecurityConfig.java

`java

package com.codehows.taelimbe.user.config;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.List;

@Configuration
@RequiredArgsConstructor
public class SecurityConfig {
    private final AuthEntryPoint authEntryPoint;
    private final JwtFilter jwtFilter;
    private final UserDetailsService userDetailsService;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .sessionManagement
                        ((session) -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/login").permitAll()
                        .anyRequest().permitAll()) //?˜ì¤‘??ê¼?ì§€?°ê¸°
                        //.anyRequest().authenticated())
                .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling((ex) -> ex.authenticationEntryPoint(authEntryPoint));
        return http.build();
    }


    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();   //ë¹„ë?ë²ˆí˜¸ ?”í˜¸??
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception
    {
        return authConfig.getAuthenticationManager();
    }
}

``n

## src/main/java/com/codehows\taelimbe\user\service\JwtService.java

`java

package com.codehows.taelimbe.user.service;

import io.jsonwebtoken.JwtParser;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Service
public class JwtService {

    // ?œë²„?€ ?´ë¼?´ì–¸?¸ê? ì£¼ê³  ë°›ëŠ” ? í° ==> HTTP Header ??Authorization ?¤ë”ê°’ì— ?€??
    // ?? Authorization Bearer <? í°ê°?
    private static final String PREFIX = "Bearer ";

    private final long expirationTime;
    private final SecretKey signingKey;

    // ?ì„±?ë? ?µí•´ ê³ ì • ??ì£¼ì…
    public JwtService(
            @Value("${jwt.secret-key}") String secretKeyString,
            @Value("${jwt.expiration}") long expirationTime) {
        // ê³ ì •???œí¬ë¦??¤ë? SecretKey ê°ì²´ë¡?ë³€??
        this.signingKey = Keys.hmacShaKeyFor(secretKeyString.getBytes(StandardCharsets.UTF_8));
        this.expirationTime = expirationTime;
    }

    // loginId(ID)ë¥?ë°›ì•„??JWT ?ì„±
    public String generateToken(String username, Long userId) {
        return Jwts.builder()
                .setSubject(username)
                .claim("userId", userId)   // userId ?¬í•¨!
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + expirationTime)) // ???˜ì •
                .signWith(signingKey, SignatureAlgorithm.HS256) // ???˜ì •
                .compact();
    }

    public Long extractUserId(String token) {
        try {
            JwtParser parser = Jwts.parserBuilder()
                    .setSigningKey(signingKey)
                    .build();

            return parser.parseClaimsJws(token.replace("Bearer ", ""))
                    .getBody()
                    .get("userId", Long.class);
        } catch (Exception e) {
            return null;
        }
    }




    // JWTë¥?ë°›ì•„??id(ID)ë¥?ë°˜í™˜
    public String parseToken(HttpServletRequest request) {
        // ?”ì²­ ?¤ë”?ì„œ Authorization ?¤ë”ê°’ì„ ê°€?¸ì˜´
        // ?? header = Bearer <? í°ê°?
        String header = request.getHeader(HttpHeaders.AUTHORIZATION);
        if (header != null && header.startsWith(PREFIX)) {
            try {
                JwtParser parser = Jwts.parserBuilder()
                        .setSigningKey(signingKey)
                        .build();

                String id = parser.parseClaimsJws(header.replace(PREFIX, ""))
                        .getBody()
                        .getSubject();

                return id;
            } catch (Exception e) {
                // ? í° ?Œì‹± ?¤íŒ¨ ??null ë°˜í™˜
                return null;
            }
        }
        return null;
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/controller/LoginController.java

`java

package com.codehows.taelimbe.user.controller;

import com.codehows.taelimbe.user.constant.Role;
import com.codehows.taelimbe.user.dto.LoginDTO;
import com.codehows.taelimbe.user.dto.LoginResponseDTO;
import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.user.service.JwtService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.security.authentication.AuthenticationManager;

@Controller
@RequiredArgsConstructor
public class LoginController {

    private final JwtService jwtService;
    private final AuthenticationManager authenticationManager;

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginDTO loginDto) {
        UsernamePasswordAuthenticationToken token =
                new UsernamePasswordAuthenticationToken(loginDto.getId(), loginDto.getPw());

        Authentication authentication = authenticationManager.authenticate(token);

        // 1. ?¸ì¦???¬ìš©?ì˜ ê¶Œí•œ???•ì¸?©ë‹ˆ?? ADMIN: 3, MANAGER: 2, USER: 1
        String roleName = authentication.getAuthorities().stream()
                .map(a -> a.getAuthority().replace("ROLE_", "")) // ADMIN, MANAGER, USER
                .findFirst()
                .orElse("USER"); // ê¸°ë³¸ê°?USER

        // enum?¼ë¡œ ë³€?????«ì level êº¼ë‚´ê¸?
        int roleLevel = Role.valueOf(roleName).getLevel();

        // 2. ?¸ì¦???¬ìš©??ê°ì²´?ì„œ storeId, userIdë¥?ì¶”ì¶œ?©ë‹ˆ??
        Long storeId = null, userId = null;
        Object principal = authentication.getPrincipal();

        if (principal instanceof User) {
            User authenticatedUser = (User) principal;

            userId = authenticatedUser.getUserId();
            System.out.println("userId :  " + userId);

            // User ?”í‹°?°ëŠ” Store ?”í‹°?°ë? ê°€ì§€ê³??ˆìœ¼ë¯€ë¡? Store?ì„œ storeIdë¥?ê°€?¸ì˜µ?ˆë‹¤.
            if (authenticatedUser.getStore() != null) {
                storeId = authenticatedUser.getStore().getStoreId();
            }
        }
        // storeIdê°€ null?´ë©´ 0L ?ëŠ” ?ì ˆ??ê¸°ë³¸ê°’ìœ¼ë¡??¤ì • (LoinReponseDTO??ë§ê²Œ Integer ?€???”êµ¬??ë§ì¶¤)
        Long finalStoreId = storeId != null ? storeId : 0L;

        // 3. JWT ? í°??ë°œê¸‰?©ë‹ˆ??
        String jwtToken = jwtService.generateToken(authentication.getName(), userId);


        // 4. ?‘ë‹µ???¬í•¨??DTOë¥??ì„±?©ë‹ˆ??
        LoginResponseDTO response = new LoginResponseDTO(jwtToken, roleLevel, finalStoreId, userId);

        return ResponseEntity.ok()
                .body(response);
//                  .header(HttpHeaders.AUTHORIZATION, "Bearer " + jwtToken)
//                   .build();
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/config/AuthEntryPoint.java

`java

package com.codehows.taelimbe.user.config;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.http.MediaType;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.io.PrintWriter;

@Component
public class AuthEntryPoint implements AuthenticationEntryPoint
{
    @Override
    public void commence(HttpServletRequest request,
                         HttpServletResponse response,
                         AuthenticationException authException) throws IOException, ServletException
    {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  // SC_UNAUTHORIZED ==> 401 ?ëŸ¬(?¸ì¦ë¶ˆê?)
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.setCharacterEncoding("UTF-8");
        PrintWriter out = response.getWriter();
        out.println("?¸ì¦???¤íŒ¨?ˆìŠµ?ˆë‹¤. : " + authException.getMessage());
    }
}

``n

## src/main/java/com/codehows/taelimbe/user/constant/Role.java

`java

package com.codehows.taelimbe.user.constant;

public enum Role {
    USER(1),
    MANAGER(2),
    ADMIN(3);

    private final int level;

    Role(int level) {
        this.level = level;
    }

    public int getLevel() {
        return level;
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/controller/UserController.java

`java

package com.codehows.taelimbe.user.controller;

import com.codehows.taelimbe.user.dto.UserDTO;
import com.codehows.taelimbe.store.entity.Store;
import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.store.repository.StoreRepository;
import com.codehows.taelimbe.user.repository.UserRepository;
import com.codehows.taelimbe.user.service.UserService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/user")
@RequiredArgsConstructor
public class UserController {
    
    private final UserService userService;
    private final PasswordEncoder passwordEncoder;
    private final UserRepository userRepository;
    private final StoreRepository storeRepository;

    @PostMapping("/signup")
    public ResponseEntity<?> signup(@RequestBody @Valid UserDTO userDto) {
        try {
            Store store = storeRepository.findByStoreId(userDto.getStoreId())
                    .orElseThrow(() -> new IllegalArgumentException("ì¡´ì¬?˜ì? ?ŠëŠ” ë§¤ì¥?…ë‹ˆ??"));

            User user = User.createUser(userDto, passwordEncoder, store);
            userService.saveUser(user);
            return ResponseEntity.ok("?Œì›ê°€???±ê³µ");
        } catch (IllegalStateException e) {
            return ResponseEntity.status(HttpStatus.CONFLICT).body(e.getMessage());
        }
    }

    // ì¤‘ë³µ?•ì¸ ?Œë??„ë•Œ
    @GetMapping("/check_loginid")
    public ResponseEntity<?> checkLoginId(@RequestParam String id) {
        boolean exists = userRepository.existsById(id);
        return ResponseEntity.ok().body(Map.of("exists", exists));
    }

    // ì§ì› ?˜ì •
    @PutMapping("/{userId}")
    @ResponseBody // JSON ?‘ë‹µ???„í•´ ì¶”ê?
    public ResponseEntity<UserDTO> updateStore( // ë©”ì„œ???´ë¦„ ?˜ì • ë°?ResponseEntity<StoreDTO> ë°˜í™˜
                                                 @PathVariable Long userId,
                                                 @RequestBody UserDTO dto
    ) {
        UserDTO updatedDto = userService.updateUser(userId, dto);
        return ResponseEntity.ok(updatedDto);
    }

    // ì§ì› ?? œ
    @DeleteMapping("/{userId}")
    public ResponseEntity<String> deleteEmployee(@PathVariable Long userId) {
        try {
            // ?œë¹„??ê³„ì¸µ???? œ ë¡œì§ ?„ì„
            userService.deleteUser(userId);

            // ?±ê³µ?ìœ¼ë¡??? œ?˜ì—ˆ?Œì„ ?Œë¦¬??ë©”ì‹œì§€ ë°˜í™˜ (?„ë¡ ?¸ì—”?œì—??alert???¬ìš© ê°€??
            return ResponseEntity.ok("ì§ì›???±ê³µ?ìœ¼ë¡??? œ?˜ì—ˆ?µë‹ˆ??");

            // ?ëŠ” ?°ì´??ë°˜í™˜ ?†ì´ 204 No Content ë°˜í™˜
            // return ResponseEntity.noContent().build();

        } catch (IllegalArgumentException e) {
            // ì§ì›??ì°¾ì„ ???†ì„ ??(?? userIdê°€ ? íš¨?˜ì? ?Šì? ê²½ìš°)
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(e.getMessage());
        } catch (Exception e) {
            // ê·????œë²„ ?¤ë¥˜
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("ì§ì› ?? œ ì¤??œë²„ ?¤ë¥˜ê°€ ë°œìƒ?ˆìŠµ?ˆë‹¤.");
        }
    }
}
``n

## src/main/java/com/codehows/taelimbe/user/dto/LoginDTO.java

`java

package com.codehows.taelimbe.user.dto;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class LoginDTO
{
    @NotBlank(message = "?„ì´?”ë? ?…ë ¥?˜ì„¸??")
    private  String id;

    @NotBlank(message = "ë¹„ë?ë²ˆí˜¸ë¥??…ë ¥?˜ì„¸??")
    private String pw ;
}
``n

## src/main/java/com/codehows/taelimbe/user/dto/LoginResponseDTO.java

`java

package com.codehows.taelimbe.user.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;

@Getter
@Builder
@AllArgsConstructor
public class LoginResponseDTO
{
    private String jwtToken;

    private Integer roleLevel;

    private Long storeId;

    private Long userId;
}
``n

## src/main/java/com/codehows/taelimbe/user/dto/UserDTO.java

`java

package com.codehows.taelimbe.user.dto;

import com.codehows.taelimbe.user.constant.Role;
import com.codehows.taelimbe.user.entity.User;
import jakarta.validation.constraints.*;
import lombok.Getter;
import lombok.Setter;
import org.hibernate.validator.constraints.Length;

import java.util.Base64;

@Getter
@Setter
public class UserDTO {

    private Long userId;
    @NotBlank(message = "ID???„ìˆ˜ ?…ë ¥ ê°’ì…?ˆë‹¤.")
    private String id;

    // ?˜ì •??ë¹„ë?ë²ˆí˜¸ ?ˆë?ê²½í•˜ë©?nullë¡?ë³´ë‚´?¼í•´??NotNull ?¬ìš©X
    @Length(min=8, max=16, message = "ë¹„ë?ë²ˆí˜¸??8???´ìƒ,  16???´í•˜ë¡??…ë ¥?´ì£¼?¸ìš”.")
    private String pw;

    @NotBlank(message = "?´ë¦„?€ ?„ìˆ˜ ?…ë ¥ ê°’ì…?ˆë‹¤.")
    private String name;

    @NotNull(message = "?„í™” ë²ˆí˜¸???„ìˆ˜ ?…ë ¥ ê°’ì…?ˆë‹¤.")
    @Pattern(regexp = "^\\d{2,3}-\\d{3,4}-\\d{4}$", message = "?„í™”ë²ˆí˜¸???˜ì´??-)???¬í•¨???¬ë°”ë¥??•ì‹(?? 010-1234-5678)?¼ë¡œ ?…ë ¥?´ì£¼?¸ìš”.")
    private String phone;

    @NotEmpty(message = "?´ë©”?¼ì? ?„ìˆ˜ ?…ë ¥ ê°’ì…?ˆë‹¤.")
    @Email(message = "?´ë©”???•ì‹?¼ë¡œ ?…ë ¥?´ì£¼?¸ìš”.")
    private String email;

    @NotNull(message = "ê¶Œí•œ?€ ?„ìˆ˜ ? íƒ ê°’ì…?ˆë‹¤.")
    private Role role;

    @NotNull(message = "?…ì²´ ? íƒ?€ ?„ìˆ˜ ? íƒ ê°’ì…?ˆë‹¤.")
    private Long storeId;

    public static UserDTO from(User user) {
        UserDTO dto = new UserDTO();
        dto.setUserId(user.getUserId());
        dto.setId(user.getId());
        dto.setPw(user.getPw());
        dto.setName(user.getName());
        dto.setPhone(user.getPhone());
        dto.setEmail(user.getEmail());
        dto.setRole(user.getRole());
        dto.setStoreId(user.getStore().getStoreId());
        return dto;
    }

    private static String decode(String encoded) {
        if (encoded == null) return null;
        return new String(Base64.getDecoder().decode(encoded));
    }

}
``n

## src/main/java/com/codehows/taelimbe/user/dto/UserResponseDTO.java

`java

package com.codehows.taelimbe.user.dto;

import com.codehows.taelimbe.user.constant.Role;
import com.codehows.taelimbe.user.entity.User;
import lombok.Builder;
import lombok.Getter;

@Getter
@Builder
public class UserResponseDTO {

    private Long userId;
    private String id;
    private String name;
    private String phone;
    private String email;
    private Role role;
    private Long storeId;

    public static UserResponseDTO fromEntity(User user) {
        return UserResponseDTO.builder()
                .userId(user.getUserId())
                .id(user.getId())
                .name(user.getName())
                .phone(user.getPhone())
                .email(user.getEmail())
                .role(user.getRole())
                // store ê°ì²´?ì„œ storeIdë¥?ì¶”ì¶œ?˜ì—¬ DTO??ì§ì ‘ ë§¤í•‘
                .storeId(user.getStore() != null ? user.getStore().getStoreId() : null)
                .build();
    }

}
``n

## src/main/java/com/codehows/taelimbe/user/entity/User.java

`java

package com.codehows.taelimbe.user.entity;

import com.codehows.taelimbe.store.entity.Store;
import com.codehows.taelimbe.user.constant.Role;
import com.codehows.taelimbe.user.dto.UserDTO;
import jakarta.persistence.*;
import lombok.*;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import java.util.Collection;
import java.util.List;

@Entity
@Table(name = "user")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User implements UserDetails {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_id")
    private Long userId;

    @Column(name = "id", length = 20, unique = true, nullable = false)
    private String id;

    @Column(name = "pw", length = 255, nullable = false)
    private String pw;

    @Column(name = "name", length = 20, nullable = false)
    private String name;

    @Column(name = "phone", length = 20, nullable = false)
    private String phone;

    @Column(name = "email", length = 50, nullable = false)
    private String email;

    @Enumerated(EnumType.STRING)
    @Column(name = "role", nullable = false)
    private Role role;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "store_id")
    private Store store;

    public static User createUser(UserDTO dto, PasswordEncoder encoder, Store store) {
        return User.builder()
                .id(dto.getId())
                .pw(encoder.encode(dto.getPw()))
                .name(dto.getName())
                .phone(dto.getPhone())
                .email(dto.getEmail())
                .role(dto.getRole())
                .store(store)
                .build();
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return List.of(new SimpleGrantedAuthority("ROLE_" + this.role.toString()));
    }

    @Override
    public String getPassword() {
        return this.pw;
    }

    @Override
    public String getUsername() {
        return this.id;
    }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }

    @Override
    public boolean isEnabled() { return true; }
}
``n

## src/main/java/com/codehows/taelimbe/user/repository/UserRepository.java

`java

package com.codehows.taelimbe.user.repository;

import com.codehows.taelimbe.user.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;
import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {

    boolean existsById(String id);
    Optional<User> findById(String id);

    // ?’¡ Fetch Join???¬ìš©?˜ì—¬ Userë¥?ë¡œë“œ????Store ?•ë³´??ì¦‰ì‹œ ë¡œë“œ?©ë‹ˆ??
    @Query("SELECT u FROM User u JOIN FETCH u.store WHERE u.id = :id")
    Optional<User> findByIdWithStore(String id);

    List<User> findByStore_StoreId(Long storeId);

}
``n

## src/main/java/com/codehows/taelimbe/user/service/CustomUserDetailsService.java

`java

package com.codehows.taelimbe.user.service;

import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;


@Service
@RequiredArgsConstructor
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;

    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String id) throws UsernameNotFoundException {
        // username = ?¬ìš©?ê? ?…ë ¥??loginId (?? "user01")
        User user = userRepository.findByIdWithStore(id)
                .orElseThrow(() -> new UsernameNotFoundException("?¬ìš©?ë? ì°¾ì„ ???†ìŠµ?ˆë‹¤: " + id));

        return user;
    }

}
``n

## src/main/java/com/codehows/taelimbe/user/service/UserService.java

`java

package com.codehows.taelimbe.user.service;

import com.codehows.taelimbe.store.entity.Store;
import com.codehows.taelimbe.store.repository.StoreRepository;
import com.codehows.taelimbe.user.dto.UserDTO;
import com.codehows.taelimbe.user.entity.User;
import com.codehows.taelimbe.user.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
@Transactional
public class UserService {

    private final UserRepository userRepository;
    private final StoreRepository storeRepository;
    private final PasswordEncoder passwordEncoder;

    public void saveUser(User user){
        validateDuplicateUser(user);
        userRepository.save(user);
    }

    public void validateDuplicateUser(User user)
    {
        boolean loginIdExists = userRepository.existsById(user.getId());
        if (loginIdExists)
        {
            throw new IllegalStateException ("?´ë? ?¬ìš© ì¤‘ì¸ ?„ì´?”ì…?ˆë‹¤.");
        }
    }

    @Transactional
    public UserDTO updateUser(Long userId, UserDTO dto) {
        // 1. ê¸°ì¡´ User ?”í‹°??ì¡°íšŒ
        User target = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException(
                        "?…ë°?´íŠ¸ ?€??ì§ì›(UserId: " + userId + ")??ì°¾ì„ ???†ìŠµ?ˆë‹¤."
                ));

        // 2. ?„ì´??ë³€ê²?(ì¤‘ë³µ ?•ì¸)
        if (dto.getId() != null && !dto.getId().equals(target.getId())) {
            // ì¤‘ë³µ ?•ì¸
            if (userRepository.existsById(dto.getId())) {
                throw new IllegalStateException("?´ë? ?¬ìš© ì¤‘ì¸ ?„ì´?”ì…?ˆë‹¤.");
            }
            target.setId(dto.getId());
        }

        // 3. ë¹„ë?ë²ˆí˜¸ ë³€ê²?(?…ë ¥??ê²½ìš°ë§?
        if (dto.getPw() != null && !dto.getPw().isEmpty()) {
            String encodedPassword = passwordEncoder.encode(dto.getPw());
            target.setPw(encodedPassword);
        }

        // 4. ?´ë¦„, ?„í™”ë²ˆí˜¸, ?´ë©”???…ë°?´íŠ¸
        if (dto.getName() != null && !dto.getName().isEmpty()) {
            target.setName(dto.getName());
        }

        if (dto.getPhone() != null && !dto.getPhone().isEmpty()) {
            target.setPhone(dto.getPhone());
        }

        if (dto.getEmail() != null && !dto.getEmail().isEmpty()) {
            target.setEmail(dto.getEmail());
        }

        // 5. Store (ë§¤ì¥) ?…ë°?´íŠ¸ ì²˜ë¦¬
        if (dto.getStoreId() != null) {
            Store store = storeRepository.findById(dto.getStoreId())
                    .orElseThrow(() -> new IllegalArgumentException(
                            "ë§¤ì¥(StoreId: " + dto.getStoreId() + ")??ì°¾ì„ ???†ìŠµ?ˆë‹¤."
                    ));
            target.setStore(store);
        }

        // 6. Role (ê¶Œí•œ) ?…ë°?´íŠ¸ ì²˜ë¦¬
        if (dto.getRole() != null) {
            target.setRole(dto.getRole());
        }

        // 7. ?…ë°?´íŠ¸???”í‹°???€??
        User updated = userRepository.save(target);

        // 8. ?…ë°?´íŠ¸???”í‹°?°ë? DTOë¡?ë³€?˜í•˜??ë°˜í™˜
        return UserDTO.from(updated);
    }

    @Transactional
    public void deleteUser(Long userId) {
        userRepository.findById(userId)
                .ifPresentOrElse(
                        user -> userRepository.delete(user),
                        () -> { throw new IllegalArgumentException("?´ë‹¹ ID??ì§ì›??ì°¾ì„ ???†ìŠµ?ˆë‹¤: " + userId); }
                );
    }
}
``n

